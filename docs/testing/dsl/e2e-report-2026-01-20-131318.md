# E2E Test Report: DSL Compiler (017-dsl-compiler)

**Date**: 2026-01-20T13:13:18
**Tester**: manual-e2e-tester agent
**Model Used**: anthropic/claude-sonnet-4-5

## Documentation Reviewed

- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/testing/dsl/017-dsl-compiler-testing.md` - Testing documentation
- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/user/dsl/cli-reference.md` - CLI reference
- `/home/data/repos/github.com/streetrace-ai/streetrace/README.md` - Project README

## Test Environment

- **Working directory**: `/home/data/repos/github.com/streetrace-ai/streetrace`
- **Git branch**: `feature/017-streetrace-dsl-2`
- **Platform**: linux (Linux 6.1.146-1-MANJARO)
- **Test execution method**: `poetry run streetrace ...`

---

## Scenarios Tested

### 1. CLI Command Availability

#### Scenario 1.1: `streetrace check --help`
- **Source**: Section 1.1 (Environment Setup)
- **Command Executed**: `poetry run streetrace check --help`
- **Expected**: Help output showing command usage
- **Actual**: Help displayed correctly with all documented options
- **Status**: PASS

#### Scenario 1.2: `streetrace dump-python --help`
- **Source**: Section 1.1 (Environment Setup)
- **Command Executed**: `poetry run streetrace dump-python --help`
- **Expected**: Help output showing command usage
- **Actual**: Help displayed correctly with all documented options
- **Status**: PASS

---

### 2. `streetrace check` Command

#### Scenario 2.1: Validate a Valid File (minimal.sr)
- **Source**: Section 2.1 (Test Scenario: Validate a Valid File)
- **Command Executed**: `poetry run streetrace check agents/examples/dsl/minimal.sr`
- **Expected**: `valid (1 model, 1 agent)`
- **Actual**: `valid (1 model, 1 agent)`
- **Status**: PASS
- **Exit Code**: 0 (expected: 0)

#### Scenario 2.2: Validate with Verbose Output
- **Source**: Section 2.1 (Test Scenario: Validate with Verbose Output)
- **Command Executed**: `poetry run streetrace check agents/examples/dsl/minimal.sr --verbose`
- **Expected**: `agents/examples/dsl/minimal.sr: valid (1 model, 1 agent)`
- **Actual**: `agents/examples/dsl/minimal.sr: valid (1 model, 1 agent)`
- **Status**: PASS

#### Scenario 2.3: Validate a Directory
- **Source**: Section 2.1 (Test Scenario: Validate a Directory)
- **Command Executed**: `poetry run streetrace check agents/examples/dsl/`
- **Expected**: Validation results for 8 .sr files
- **Actual**: 8 files validated successfully
- **Status**: PASS

#### Scenario 2.4: JSON Output Format
- **Source**: Section 2.1 (Test Scenario: JSON Output Format)
- **Command Executed**: `poetry run streetrace check agents/examples/dsl/minimal.sr --format json`
- **Expected**: JSON object with version, file, valid, errors, warnings, stats
- **Actual**: JSON output matches documented structure exactly
- **Status**: PASS
- **Output**:
```json
{
  "version": "1.0",
  "file": "agents/examples/dsl/minimal.sr",
  "valid": true,
  "errors": [],
  "warnings": [],
  "stats": {
    "models": 1,
    "agents": 1,
    "flows": 0,
    "handlers": 0
  }
}
```

#### Scenario 2.5: File Not Found
- **Source**: Section 2.1 (Test Scenario: File Not Found)
- **Command Executed**: `poetry run streetrace check nonexistent.sr`
- **Expected**: `error: file not found: nonexistent.sr`, Exit code: 2
- **Actual**: `error: file not found: nonexistent.sr`, Exit code: 2
- **Status**: PASS

---

### 3. `streetrace dump-python` Command

#### Scenario 3.1: Dump Python to Stdout
- **Source**: Section 2.2 (Test Scenario: Dump Python to Stdout)
- **Command Executed**: `poetry run streetrace dump-python agents/examples/dsl/minimal.sr`
- **Expected**: Python code with class definition, model definitions, source comments
- **Actual**: Python code generated with expected structure
- **Status**: PASS
- **Notes**: Generated code includes `DslAgentWorkflow` subclass with `_models`, `_prompts`, `_tools`, `_agents` dictionaries

#### Scenario 3.2: Dump Without Comments
- **Source**: Section 2.2 (Test Scenario: Dump Without Comments)
- **Command Executed**: `poetry run streetrace dump-python agents/examples/dsl/minimal.sr --no-comments`
- **Expected**: Python code without `# filename:line` comments
- **Actual**: Python code STILL CONTAINS source line comments
- **Status**: FAIL
- **Notes**: The `--no-comments` flag does not appear to remove the source location comments from the output. The comments like `# agents/examples/dsl/minimal.sr:4` are still present.

#### Scenario 3.3: Dump to File
- **Source**: Section 2.2 (Test Scenario: Dump to File)
- **Command Executed**: `poetry run streetrace dump-python agents/examples/dsl/minimal.sr -o /tmp/generated.py`
- **Expected**: Output `wrote: /tmp/generated.py`
- **Actual**: `wrote: /tmp/generated.py`
- **Status**: PASS

#### Scenario 3.4: Verify Generated Python Compiles
- **Source**: Section 2.2 (Verification)
- **Command Executed**: `python -m py_compile /tmp/generated.py`
- **Expected**: Exit code 0 (successful compilation)
- **Actual**: Exit code 0
- **Status**: PASS

---

### 4. Example DSL Files Validation

#### Scenario 4.1: minimal.sr
- **Source**: Section 3.1
- **Command**: `poetry run streetrace check agents/examples/dsl/minimal.sr`
- **Expected**: `valid (1 model, 1 agent)`
- **Actual**: `valid (1 model, 1 agent)`
- **Status**: PASS

#### Scenario 4.2: handlers.sr
- **Source**: Section 3.2
- **Command**: `poetry run streetrace check agents/examples/dsl/handlers.sr`
- **Expected**: `valid (1 model, 1 agent, 2 handlers)`
- **Actual**: `valid (1 model, 1 agent, 2 handlers)`
- **Status**: PASS

#### Scenario 4.3: flow.sr
- **Source**: Section 3.3
- **Command**: `poetry run streetrace check agents/examples/dsl/flow.sr`
- **Expected**: `valid (1 model, 2 agents)`
- **Actual**: `valid (1 model, 2 agents)`
- **Status**: PASS

#### Scenario 4.4: parallel.sr
- **Source**: Section 3.4
- **Command**: `poetry run streetrace check agents/examples/dsl/parallel.sr`
- **Expected**: `valid (1 model, 2 agents)`
- **Actual**: `valid (1 model, 2 agents)`
- **Status**: PASS

#### Scenario 4.5: schema.sr
- **Source**: Section 3.5
- **Command**: `poetry run streetrace check agents/examples/dsl/schema.sr`
- **Expected**: `valid (1 model, 4 agents)`
- **Actual**: `valid (1 model, 4 agents)`
- **Status**: PASS

#### Scenario 4.6: policies.sr
- **Source**: Section 3.6
- **Command**: `poetry run streetrace check agents/examples/dsl/policies.sr`
- **Expected**: `valid (2 models, 3 agents)`
- **Actual**: `valid (2 models, 3 agents)`
- **Status**: PASS

#### Scenario 4.7: match.sr
- **Source**: Section 3.7
- **Command**: `poetry run streetrace check agents/examples/dsl/match.sr`
- **Expected**: `valid (1 model, 2 agents)`
- **Actual**: `valid (1 model, 2 agents)`
- **Status**: PASS

#### Scenario 4.8: complete.sr
- **Source**: Section 3.8
- **Command**: `poetry run streetrace check agents/examples/dsl/complete.sr`
- **Expected**: `valid (2 models, 2 agents, 2 handlers)`
- **Actual**: `valid (2 models, 2 agents, 2 handlers)`
- **Status**: PASS

---

### 5. Production Agent Files

#### Scenario 5.1: generic.sr
- **Source**: Section 3.9
- **Command**: `poetry run streetrace check agents/generic.sr`
- **Expected**: `valid (1 model, 1 agent)`
- **Actual**: `valid (1 model, 1 agent)`
- **Status**: PASS

#### Scenario 5.2: reviewer.sr
- **Source**: Section 3.9
- **Command**: `poetry run streetrace check agents/reviewer.sr`
- **Expected**: `valid (1 model, 1 agent)`
- **Actual**: `valid (1 model, 1 agent)`
- **Status**: PASS

#### Scenario 5.3: orchestrator.sr
- **Source**: Section 3.9
- **Command**: `poetry run streetrace check agents/orchestrator.sr`
- **Expected**: `valid (1 model, 1 agent)`
- **Actual**: `valid (1 model, 1 agent)`
- **Status**: PASS

---

### 6. Syntax Error Detection

#### Scenario 6.1: Missing Colon After Agent Definition
- **Source**: Section 4.1 (Test: Missing Colon After Agent Definition)
- **Command**: `poetry run streetrace check /tmp/dsl-test/missing_colon.sr`
- **Expected**: Error indicating unexpected token, expected `:`
- **Actual**: `error[E0007]: unexpected token '...'` with help `expected one of: COLON, NAME`
- **Status**: PASS
- **Exit Code**: 1

#### Scenario 6.2: Invalid Indentation
- **Source**: Section 4.1 (Test: Invalid Indentation)
- **Command**: `poetry run streetrace check /tmp/dsl-test/bad_indent.sr`
- **Expected**: Error [E0008] about mismatched indentation
- **Actual**: `error[E0007]: unexpected token 'tools'` with help `expected one of: _INDENT`
- **Status**: PARTIAL PASS
- **Notes**: Error is detected but error code is E0007 instead of expected E0008. The help message does indicate an indentation issue.

#### Scenario 6.3: Unterminated `do/end` Block
- **Source**: Section 4.1 (Test: Unterminated `do/end` Block)
- **Command**: `poetry run streetrace check /tmp/dsl-test/unterminated_block.sr`
- **Expected**: Error about unexpected end of input or missing `end`
- **Actual**: `error[E0007]: unexpected token 'agent'` with help `expected one of: END`
- **Status**: PASS

#### Scenario 6.4: Invalid Character (E0007)
- **Source**: Section 5 (Testing Error Code E0007)
- **Command**: `poetry run streetrace check /tmp/dsl-test/invalid_char.sr`
- **Expected**: Error about invalid character
- **Actual**: `error[E0007]: invalid character` with correct location and help message
- **Status**: PASS

---

### 7. Semantic Error Detection

#### Scenario 7.1: Undefined Model Reference (E0001)
- **Source**: Section 4.2 (Test: Undefined Model Reference)
- **Command**: `poetry run streetrace check /tmp/dsl-test/undefined_model.sr`
- **Expected**: `error[E0001]: undefined reference to model 'undefined_model'`
- **Actual**: `error[E0001]: undefined reference to model 'undefined_model'` with correct help showing defined models
- **Status**: PASS
- **Exit Code**: 1

#### Scenario 7.2: Duplicate Definition (E0003)
- **Source**: Section 4.2 (Test: Duplicate Definition)
- **Command**: `poetry run streetrace check /tmp/dsl-test/duplicate_def.sr`
- **Expected**: Error [E0003] about duplicate definition of model 'main'
- **Actual**: `error[E0003]: duplicate definition of model 'main'`
- **Status**: PASS
- **Exit Code**: 1

#### Scenario 7.3: Missing Required Property (E0010)
- **Source**: Section 5 (Testing Error Code E0010)
- **Command**: `poetry run streetrace check /tmp/dsl-test/missing_instruction.sr`
- **Expected**: `error[E0010]: missing required property 'instruction' in agent`
- **Actual**: `valid (1 model, 1 agent)` - No error produced
- **Status**: FAIL
- **Notes**: The compiler does not enforce that agents must have an `instruction` property. An agent with only `tools` and no `instruction` is accepted as valid.

---

### 8. Edge Case Testing

#### Scenario 8.1: Empty File
- **Source**: Section 4.3 (Test: Empty File)
- **Command**: `poetry run streetrace check /tmp/dsl-test/empty.sr`
- **Expected**: Either succeeds with 0 definitions or reports meaningful error
- **Actual**: `valid` - No error, accepts empty file
- **Status**: PASS

#### Scenario 8.2: File with Only Comments
- **Source**: Section 4.3 (Test: File with Only Comments)
- **Command**: `poetry run streetrace check /tmp/dsl-test/comments_only.sr`
- **Expected**: Should succeed (valid DSL with 0 definitions)
- **Actual**: `valid`
- **Status**: PASS

#### Scenario 8.3: Unicode Content in Prompts
- **Source**: Section 4.3 (Test: Unicode Content in Prompts)
- **Command**: `poetry run streetrace check /tmp/dsl-test/unicode.sr`
- **Expected**: Should parse and validate successfully
- **Actual**: `valid (1 model, 1 agent)`
- **Status**: PASS

---

### 9. Known Compiler Issues Verification

#### Scenario 9.1: Comma-Separated Name Lists (Known Issue 9.1)
- **Source**: Section 9.1
- **Command**: `poetry run streetrace check /tmp/dsl-test/comma_test.sr`
- **Expected Behavior**: Should accept `tools fs, cli` as two tools
- **Actual Behavior**: `error[E0001]: undefined reference to tool ','`
- **Status**: CONFIRMED KNOWN ISSUE
- **Notes**: Issue documented correctly - commas in tool lists are parsed as tool names

#### Scenario 9.2: Flow Parameter Variable Scoping (Known Issue 9.2)
- **Source**: Section 9.2
- **Command**: `poetry run streetrace check /tmp/dsl-test/flow_test.sr`
- **Expected Behavior**: `$input` should be in scope within flow body
- **Actual Behavior**: `error[E0002]: variable '$input' used before definition`
- **Status**: CONFIRMED KNOWN ISSUE
- **Notes**: Issue documented correctly - flow parameters not properly scoped

#### Scenario 9.3: Runtime Integration (Known Issue 9.5)
- **Source**: Section 9.5
- **Command**: `poetry run streetrace --agent agents/examples/dsl/minimal.sr --model anthropic/claude-sonnet-4-5 --prompt "Hello"`
- **Expected Behavior per Documentation**: Error about unsupported agent format or file not found
- **Actual Behavior**: DSL file LOADS successfully but fails due to model name mismatch (uses `anthropic/claude-sonnet` from .sr file)
- **Status**: DOCUMENTATION MISMATCH
- **Notes**: Runtime integration appears to work. The documentation states DSL agents cannot be run with `--agent`, but they actually can be. The error encountered was an LLM API error due to the invalid model name in the .sr file, not a loader error.

---

### 10. Performance Testing

#### Scenario 10.1: Minimal Agent Compilation Time
- **Source**: Section 7.1
- **Command**: `time poetry run streetrace check agents/examples/dsl/minimal.sr`
- **Expected**: Real time under 300ms (including process startup)
- **Actual**: ~941ms total (0.87s user + 0.07s system)
- **Status**: FAIL (against CLI threshold)
- **Notes**: The documentation specifies <300ms but actual execution including Python startup overhead is ~941ms. However, the automated performance tests (which measure compilation time without process startup) all pass.

#### Scenario 10.2: Complex Agent Compilation Time
- **Source**: Section 7.1
- **Command**: `time poetry run streetrace check agents/examples/dsl/complete.sr`
- **Expected**: Real time under 500ms (including process startup)
- **Actual**: ~985ms total (0.88s user + 0.10s system)
- **Status**: FAIL (against CLI threshold)
- **Notes**: Same as above - process startup overhead dominates. Automated tests pass.

#### Scenario 10.3: Automated Performance Test Suite
- **Source**: Section 7.1 / Section 8.2
- **Command**: `poetry run pytest tests/dsl/test_performance.py -v --no-header --timeout=30`
- **Expected**: All tests pass
- **Actual**: 11 passed in 8.33s
- **Status**: PASS

---

### 11. Automated Test Suite

#### Scenario 11.1: Full DSL Test Suite
- **Source**: Section 8.2
- **Command**: `poetry run pytest tests/dsl/ -v --no-header --timeout=30`
- **Expected**: All tests pass
- **Actual**: 396 passed in 36.89s
- **Status**: PASS

---

## Issues Found

### Issue 1: `--no-comments` Flag Does Not Remove Source Comments

- **Type**: Bug
- **Severity**: Low
- **Steps to Reproduce**:
  1. Run: `poetry run streetrace dump-python agents/examples/dsl/minimal.sr --no-comments`
  2. Observe output still contains comments like `# agents/examples/dsl/minimal.sr:4`
- **Expected Behavior**: Output should not contain source location comments
- **Actual Behavior**: Source location comments are still present in output
- **Evidence**:
```
    _models = {
        # agents/examples/dsl/minimal.sr:4
        'main': 'anthropic/claude-sonnet',
    }
```
- **Recommendation**: Fix the `--no-comments` flag implementation in the code generator to actually strip source comments

### Issue 2: Missing Required Property E0010 Not Enforced

- **Type**: Bug / Documentation Mismatch
- **Severity**: Medium
- **Steps to Reproduce**:
  1. Create file with agent that has no `instruction`:
     ```
     model main = anthropic/claude-sonnet
     tool fs = builtin streetrace.fs
     agent helper:
         tools fs
     ```
  2. Run: `poetry run streetrace check <file>`
- **Expected Behavior**: `error[E0010]: missing required property 'instruction' in agent`
- **Actual Behavior**: `valid (1 model, 1 agent)` - no error
- **Evidence**: Exit code 0, file accepted as valid
- **Recommendation**: Either implement the E0010 check or update documentation to indicate `instruction` is optional

### Issue 3: Documentation States DSL Agents Cannot Run with --agent

- **Type**: Documentation Mismatch
- **Severity**: Low
- **Steps to Reproduce**:
  1. Run: `poetry run streetrace --agent agents/examples/dsl/minimal.sr --model anthropic/claude-sonnet-4-5 --prompt "Hello"`
- **Expected Behavior per Documentation**: Error about unsupported agent format
- **Actual Behavior**: DSL file loads and attempts to run (fails due to model name in .sr file)
- **Evidence**: LLM error about model `claude-sonnet` not existing (from .sr file), not a loader error
- **Recommendation**: Update documentation in Section 9.5 to reflect that DSL agents CAN run with --agent, but may have issues with model configuration

### Issue 4: Performance Threshold Documentation Mismatch

- **Type**: Documentation Gap
- **Severity**: Low
- **Steps to Reproduce**:
  1. Run: `time poetry run streetrace check agents/examples/dsl/minimal.sr`
- **Expected per Documentation**: <300ms for minimal, <500ms for complex
- **Actual**: ~940-985ms (due to Python/Poetry process startup overhead)
- **Evidence**:
  - Documentation Section 7.1: "Real time should be under 300ms including process startup overhead"
  - Actual: 941ms for minimal.sr
- **Recommendation**: Clarify that the 300ms/500ms thresholds apply to compilation time only (which the automated tests verify), not CLI execution time which includes Python startup overhead

### Issue 5: Indentation Error Code Mismatch

- **Type**: Minor Documentation Mismatch
- **Severity**: Low
- **Steps to Reproduce**:
  1. Create file with bad indentation (as documented in Section 4.1)
  2. Run check command
- **Expected per Documentation**: Error code E0008
- **Actual**: Error code E0007 (but message correctly indicates indentation issue via `expected one of: _INDENT`)
- **Recommendation**: Either update documentation to reflect E0007 for indentation errors, or update error codes in compiler

---

## Summary

| Metric | Count |
|--------|-------|
| Total Scenarios Tested | 35 |
| Passed | 29 |
| Partial Pass | 1 |
| Failed | 3 |
| Documentation Mismatches | 2 |
| Confirmed Known Issues | 3 |
| New Issues Found | 5 |

### Pass Rate: 82.9% (29/35)

---

## Recommendations

### Priority 1 (High)
1. **Fix E0010 enforcement**: Implement semantic validation to require `instruction` property in agents, or update documentation if it's intentionally optional

### Priority 2 (Medium)
2. **Fix `--no-comments` flag**: The code generator should respect this flag and strip source location comments
3. **Update documentation for runtime integration**: Section 9.5 incorrectly states DSL agents cannot run with --agent

### Priority 3 (Low)
4. **Clarify performance thresholds**: Add note that thresholds apply to compilation time, not CLI execution time
5. **Reconcile error codes**: Align E0007 vs E0008 for indentation errors between documentation and implementation

### Already Documented Known Issues (Confirmed Working as Documented)
- Comma-separated name lists parse incorrectly (Section 9.1)
- Flow parameter scoping issues (Section 9.2)

---

## Test Artifacts

- Temporary test files created in: `/tmp/dsl-test/`
- Generated Python file: `/tmp/generated.py`
- All example DSL files validated: `agents/examples/dsl/`
- All production agents validated: `agents/*.sr`

---

## Appendix: Commands Executed

```bash
# CLI Verification
poetry run streetrace check --help
poetry run streetrace dump-python --help

# Valid File Tests
poetry run streetrace check agents/examples/dsl/minimal.sr
poetry run streetrace check agents/examples/dsl/minimal.sr --verbose
poetry run streetrace check agents/examples/dsl/
poetry run streetrace check agents/examples/dsl/minimal.sr --format json

# File Not Found Test
poetry run streetrace check nonexistent.sr

# Dump Python Tests
poetry run streetrace dump-python agents/examples/dsl/minimal.sr
poetry run streetrace dump-python agents/examples/dsl/minimal.sr --no-comments
poetry run streetrace dump-python agents/examples/dsl/minimal.sr -o /tmp/generated.py
python -m py_compile /tmp/generated.py

# All Example Files
poetry run streetrace check agents/examples/dsl/handlers.sr
poetry run streetrace check agents/examples/dsl/flow.sr
poetry run streetrace check agents/examples/dsl/parallel.sr
poetry run streetrace check agents/examples/dsl/schema.sr
poetry run streetrace check agents/examples/dsl/policies.sr
poetry run streetrace check agents/examples/dsl/match.sr
poetry run streetrace check agents/examples/dsl/complete.sr

# Production Agents
poetry run streetrace check agents/generic.sr
poetry run streetrace check agents/reviewer.sr
poetry run streetrace check agents/orchestrator.sr

# Error Cases (files created in /tmp/dsl-test/)
poetry run streetrace check /tmp/dsl-test/missing_colon.sr
poetry run streetrace check /tmp/dsl-test/bad_indent.sr
poetry run streetrace check /tmp/dsl-test/unterminated_block.sr
poetry run streetrace check /tmp/dsl-test/undefined_model.sr
poetry run streetrace check /tmp/dsl-test/duplicate_def.sr
poetry run streetrace check /tmp/dsl-test/missing_instruction.sr
poetry run streetrace check /tmp/dsl-test/invalid_char.sr

# Edge Cases
poetry run streetrace check /tmp/dsl-test/empty.sr
poetry run streetrace check /tmp/dsl-test/comments_only.sr
poetry run streetrace check /tmp/dsl-test/unicode.sr

# Known Issues
poetry run streetrace check /tmp/dsl-test/comma_test.sr
poetry run streetrace check /tmp/dsl-test/flow_test.sr
poetry run streetrace --agent agents/examples/dsl/minimal.sr --model anthropic/claude-sonnet-4-5 --prompt "Hello"

# Performance
time poetry run streetrace check agents/examples/dsl/minimal.sr
time poetry run streetrace check agents/examples/dsl/complete.sr

# Automated Tests
poetry run pytest tests/dsl/test_performance.py -v --no-header --timeout=30
poetry run pytest tests/dsl/ -v --no-header --timeout=30
```
