# E2E Test Report: Flow Event Yielding

**Date**: 2026-01-27 02:38:34 UTC
**Tester**: manual-e2e-tester agent
**Model Used**: anthropic/claude-sonnet-4-5

## Documentation Reviewed

- `docs/user/dsl/flow-events/overview.md` - User documentation for event streaming
- `docs/testing/dsl/flow-events/scenarios.md` - Test scenarios specification
- `docs/testing/dsl/flow-events/environment-setup.md` - Test environment setup
- `docs/dev/dsl/flow-events/overview.md` - Architecture documentation
- `docs/tasks/017-dsl/flow-event-yielding/tasks.md` - Task definition
- `docs/tasks/017-dsl/flow-event-yielding/todo.md` - Implementation plan

## Test Environment

- **Working Directory**: `/home/data/repos/github.com/streetrace-ai/streetrace`
- **Branch**: `feature/017-streetrace-dsl-2`
- **StreetRace Version**: 0.1.21
- **Python Version**: Poetry-managed environment
- **Model**: `anthropic/claude-sonnet-4-5`
- **Log Level**: DEBUG

## Scenarios Tested

### Scenario 1: Single Agent Flow Yields ADK Events

- **Source**: `docs/testing/dsl/flow-events/scenarios.md`, Scenario 1
- **Test File Created**: `tmp-e2e-test/agents/single_agent_flow.sr`
- **DSL Compilation**: PASS (`valid (1 model, 1 agent, 1 flow)`)
- **Generated Code Verification**: PASS - Correct async generator pattern with:
  - `AsyncGenerator[Event | FlowEvent, None]` return type
  - `async for _event in ctx.run_agent(...): yield _event` pattern
  - `ctx.get_last_result()` for result capture
- **Commands Executed**:
  ```bash
  poetry run streetrace check tmp-e2e-test/agents/single_agent_flow.sr
  poetry run streetrace dump-python tmp-e2e-test/agents/single_agent_flow.sr
  poetry run streetrace --agent=tmp-e2e-test/agents/single_agent_flow.sr --prompt="List files" --model=anthropic/claude-sonnet-4-5
  ```
- **Expected**: Function call events, function result events, agent final response
- **Actual**:
  - `[Function Call] list_directory({'path': '.'})` displayed
  - `[Function Response] tool_name: list_directory, result: SUCCESS` displayed
  - Agent's comprehensive response with directory listing displayed
- **Status**: PASS
- **Notes**: All ADK events rendered correctly with rich formatting

### Scenario 2: Multi-Agent Flow Yields Interleaved Events

- **Source**: `docs/testing/dsl/flow-events/scenarios.md`, Scenario 2
- **Test File Created**: `tmp-e2e-test/agents/multi_agent_flow.sr`
- **DSL Compilation**: PASS (`valid (1 model, 2 agents, 1 flow)`)
- **Commands Executed**:
  ```bash
  poetry run streetrace check tmp-e2e-test/agents/multi_agent_flow.sr
  poetry run streetrace --agent=tmp-e2e-test/agents/multi_agent_flow.sr --prompt="Analyze project" --model=anthropic/claude-sonnet-4-5
  ```
- **Expected**: Events from analyzer agent first, then summarizer agent
- **Actual**:
  - Analyzer agent events: Multiple `[Function Call]` and `[Function Response]` events displayed
  - Analyzer produced detailed project analysis
  - Summarizer received analysis and produced summary
- **Status**: PASS
- **Notes**:
  - Warning logged: `Failed to evaluate prompt 'summarize': 'analysis'` - This occurs during agent creation when the `${analysis}` variable is not yet available. The warning is non-fatal as the agent receives the analysis as an argument.
  - See Issue 1 below for details.

### Scenario 3: Call LLM Yields FlowEvents

- **Source**: `docs/testing/dsl/flow-events/scenarios.md`, Scenario 3
- **Test File Created**: `tmp-e2e-test/agents/call_llm_flow.sr`
- **DSL Compilation**: PASS (`valid (1 model, 1 flow)`)
- **Generated Code Verification**: PASS - Correct async generator pattern with:
  - `async for _event in ctx.call_llm('greet'): yield _event`
  - `async for _event in ctx.call_llm('farewell'): yield _event`
- **Commands Executed**:
  ```bash
  poetry run streetrace check tmp-e2e-test/agents/call_llm_flow.sr
  poetry run streetrace --agent=tmp-e2e-test/agents/call_llm_flow.sr --prompt="Hi there!" --model=anthropic/claude-sonnet-4-5
  ```
- **Expected**: `[LLM Call]` events with prompt name and model, followed by markdown responses
- **Actual**:
  - `[LLM Call] greet (model: anthropic/claude-sonnet-4-5)` displayed
  - Greeting response rendered as markdown
  - `[LLM Call] farewell (model: anthropic/claude-sonnet-4-5)` displayed
  - Farewell response rendered as markdown
- **Status**: PASS
- **Notes**: Both LlmCallEvent rendering working correctly

### Scenario 7: Result Capture via get_last_result

- **Source**: `docs/testing/dsl/flow-events/scenarios.md`, Scenario 7
- **Test File Created**: `tmp-e2e-test/agents/result_capture.sr`
- **DSL Compilation**: PASS (`valid (1 model, 1 flow)`)
- **Commands Executed**:
  ```bash
  poetry run streetrace check tmp-e2e-test/agents/result_capture.sr
  poetry run streetrace --agent=tmp-e2e-test/agents/result_capture.sr --prompt="compute" --model=anthropic/claude-sonnet-4-5
  ```
- **Expected**: LLM returns "COMPUTED_VALUE_123" which is captured and returned as final response
- **Actual**:
  - `[LLM Call] compute (model: anthropic/claude-sonnet-4-5)` displayed
  - `COMPUTED_VALUE_123` displayed as final response
- **Status**: PASS
- **Notes**: Result capture via `ctx.get_last_result()` works correctly

### Scenario 8: Error Handling During Event Yielding

- **Source**: `docs/testing/dsl/flow-events/scenarios.md`, Scenario 8
- **Test File Created**: `tmp-e2e-test/agents/error_flow.sr`
- **DSL Compilation**: PASS (`valid (1 model, 1 flow)`) - Does not catch undefined variable at compile time
- **Commands Executed**:
  ```bash
  poetry run streetrace check tmp-e2e-test/agents/error_flow.sr
  poetry run streetrace --agent=tmp-e2e-test/agents/error_flow.sr --prompt="test" --model=anthropic/claude-sonnet-4-5
  ```
- **Expected**: Error message about undefined variable displayed to user
- **Actual**:
  - Only `> test` displayed to user (no error message visible)
  - Warning logged: `Failed to evaluate prompt 'missing': 'undefined_var'`
  - Application did not crash
- **Status**: PARTIAL FAIL
- **Notes**: See Issue 2 below - error is logged but not displayed to user

### Scenario 9: Agent Entry Point (No Flow)

- **Source**: `docs/testing/dsl/flow-events/scenarios.md`, Scenario 9
- **Test File Created**: `tmp-e2e-test/agents/agent_only.sr`
- **DSL Compilation**: PASS (`valid (1 model, 1 agent)`)
- **Commands Executed**:
  ```bash
  poetry run streetrace check tmp-e2e-test/agents/agent_only.sr
  poetry run streetrace --agent=tmp-e2e-test/agents/agent_only.sr --prompt="List files" --model=anthropic/claude-sonnet-4-5
  ```
- **Expected**: Events yield even without a flow, agent executes correctly
- **Actual**:
  - `[Function Call] list_directory({'path': '.'})` displayed
  - `[Function Response] tool_name: list_directory` displayed
  - Agent's final response displayed
- **Status**: PASS
- **Notes**: Agent-only DSL files without flows correctly yield events

### Additional Verification: FlowEvent Type Fields

- **Source**: `docs/dev/dsl/flow-events/overview.md`
- **Commands Executed**:
  ```python
  from streetrace.dsl.runtime.events import LlmCallEvent, LlmResponseEvent
  call_event = LlmCallEvent(prompt_name='test', model='gpt-4', prompt_text='hello')
  response_event = LlmResponseEvent(prompt_name='test', content='hello back')
  ```
- **Expected**: `LlmCallEvent.type = 'llm_call'`, `LlmResponseEvent.type = 'llm_response'`
- **Actual**: Values match expected
- **Status**: PASS

### Additional Verification: Unit/Integration Tests

- **Commands Executed**:
  ```bash
  poetry run pytest tests/unit/dsl/runtime/ tests/integration/dsl/ -v --no-header --timeout=30 -q
  poetry run pytest tests/ -v --no-header --timeout=60 -q -x
  ```
- **Expected**: All tests pass
- **Actual**:
  - 73 tests in `tests/unit/dsl/runtime/` and `tests/integration/dsl/` passed
  - 1866 total tests passed (2 expected skips)
- **Status**: PASS

## Issues Found

### Issue 1: Confusing Warning for Flow-Scoped Variables in Agent Prompts

- **Type**: Documentation Mismatch / UX Problem
- **Severity**: Low
- **Steps to Reproduce**:
  1. Create a DSL file with a prompt that references a flow variable: `prompt summarize: """... ${analysis}"""`
  2. Use that prompt in an agent definition
  3. Use that agent in a flow where `$analysis` is assigned before running the agent
  4. Run the flow
- **Expected Behavior**: No warning, or clear documentation that this pattern generates warnings
- **Actual Behavior**: Warning logged: `Failed to evaluate prompt 'summarize': 'analysis'`
- **Evidence**: Log from Scenario 2: `2026-01-27 02:33:38,186 - streetrace.workloads.dsl_agent_factory - WARNING - Failed to evaluate prompt 'summarize': 'analysis'`
- **Recommendation**:
  - Document this behavior in user docs (flow variables not available in agent prompt templates during agent creation)
  - Consider suppressing the warning when the prompt is used within a flow context
  - Or provide a different mechanism for flow-aware agent prompts

### Issue 2: Silent Failure for Undefined Variables in call_llm

- **Type**: UX Problem
- **Severity**: Medium
- **Steps to Reproduce**:
  1. Create a DSL file with a prompt referencing an undefined variable: `prompt missing: """${undefined_var}"""`
  2. Create a flow using `call llm missing`
  3. Run the flow
- **Expected Behavior**: User sees an error message indicating the undefined variable
- **Actual Behavior**:
  - Only input prompt echoed (`> test`)
  - No visible error to user
  - Warning logged: `Failed to evaluate prompt 'missing': 'undefined_var'`
  - `_last_call_result` set to `None`, flow silently returns with no output
- **Evidence**: Scenario 8 output shows only `> test` with no error message visible to user
- **Recommendation**:
  - Display error message to user when prompt evaluation fails
  - Consider compile-time detection of undefined variables in prompts used by flows
  - At minimum, provide visible feedback that the flow did not complete successfully

### Issue 3: Test Scenario Documentation Uses Incorrect Prompt Syntax

- **Type**: Documentation Mismatch
- **Severity**: Low
- **Steps to Reproduce**:
  1. Create test files using syntax from `docs/testing/dsl/flow-events/scenarios.md`
  2. Attempt to compile with `poetry run streetrace check`
- **Expected Behavior**: DSL files compile successfully
- **Actual Behavior**: Compile error - prompts require triple-quoted strings
- **Evidence**:
  ```
  error[E0007]: unexpected token
  --> single_agent_flow.sr:7:17
     |
   7 | prompt analyze:
     | ^
     = help: expected one of: TRIPLE_QUOTED_STRING
  ```
- **Recommendation**: Update test scenario documentation to use correct DSL syntax:
  ```streetrace
  # Incorrect (from documentation)
  prompt analyze:
      List the files in the current directory...

  # Correct
  prompt analyze: """List the files in the current directory..."""
  ```

## Summary

| Metric | Value |
|--------|-------|
| Total Scenarios | 7 |
| Passed | 6 |
| Partial Fail | 1 |
| Failed | 0 |
| Issues Found | 3 |
| Documentation Gaps | 2 |

### Overall Assessment

The Flow Event Yielding feature is **working correctly** for its core functionality:

1. **DSL Compilation**: All valid DSL files with flows compile correctly
2. **Code Generation**: Async generator pattern correctly implemented with:
   - Proper return type annotations (`AsyncGenerator[Event | FlowEvent, None]`)
   - Event yielding via `async for _event in ... yield _event`
   - Result capture via `ctx.get_last_result()`
3. **ADK Event Yielding**: Agent operations yield all ADK events (function calls, responses)
4. **FlowEvent Yielding**: `call llm` operations yield `LlmCallEvent` and `LlmResponseEvent`
5. **Event Rendering**: Events display correctly with rich formatting in terminal
6. **Result Capture**: Results are correctly captured and returned from flows
7. **Unit/Integration Tests**: All 1866 tests pass

## Recommendations

### Priority 1: Fix Error User Feedback (Issue 2)
- Implement user-visible error messages when prompt evaluation fails
- Consider adding compile-time variable checking

### Priority 2: Update Test Documentation (Issue 3)
- Update `docs/testing/dsl/flow-events/scenarios.md` to use correct triple-quoted prompt syntax

### Priority 3: Document Flow Variable Behavior (Issue 1)
- Add documentation about flow-scoped variables and agent prompt resolution
- Consider suppressing or clarifying warnings for this expected pattern

### Other Observations
- The existing DSL example `agents/examples/dsl/flow.sr` uses `anthropic/claude-opus-4-5` which is not available - should be updated or parameterized
- The `parallel` block documentation mentions sequential execution - this is working as documented
