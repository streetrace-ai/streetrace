# E2E Test Report: DSL Agentic Patterns

**Date**: 2026-01-21 01:57:30 UTC
**Tester**: manual-e2e-tester agent
**Model Used**: anthropic/claude-sonnet-4-5

## Documentation Reviewed

- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/user/dsl/multi-agent-patterns.md` - User documentation for multi-agent patterns
- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/testing/dsl/017-dsl-compiler-testing.md` - Testing guide for DSL compiler

## Test Environment

- Working directory: `/home/data/repos/github.com/streetrace-ai/streetrace`
- Branch: `feature/017-streetrace-dsl-2`
- Python environment: Poetry-managed virtual environment

## Scenarios Tested

### Scenario 1: Parse and Validate coordinator.sr

- **Source**: Testing Guide Section 9.1
- **Commands Executed**:
  ```bash
  poetry run streetrace check agents/examples/dsl/coordinator.sr
  ```
- **Expected**: `valid (2 models, 3 agents)`
- **Actual**: `valid (2 models, 3 agents)`
- **Status**: PASS
- **Notes**: File validates successfully with expected model and agent counts.

### Scenario 2: Parse and Validate hierarchical.sr

- **Source**: Testing Guide Section 9.2
- **Commands Executed**:
  ```bash
  poetry run streetrace check agents/examples/dsl/hierarchical.sr
  ```
- **Expected**: `valid (2 models, 4 agents)`
- **Actual**: `valid (2 models, 4 agents)`
- **Status**: PASS
- **Notes**: File validates successfully with expected model and agent counts.

### Scenario 3: Parse and Validate iterative.sr

- **Source**: Testing Guide Section 9.3
- **Commands Executed**:
  ```bash
  poetry run streetrace check agents/examples/dsl/iterative.sr
  ```
- **Expected**: `valid (2 models, 1 agent, 1 flow)`
- **Actual**: `valid (2 models, 1 agent, 1 flow)`
- **Status**: PASS
- **Notes**: File validates successfully with expected counts including flow.

### Scenario 4: Parse and Validate combined.sr

- **Source**: Testing Guide Section 9.4
- **Commands Executed**:
  ```bash
  poetry run streetrace check agents/examples/dsl/combined.sr
  ```
- **Expected**: `valid (2 models, 7 agents, 1 flow)` per documentation
- **Actual**: `valid (2 models, 6 agents, 1 flow)`
- **Status**: PASS (with documentation mismatch)
- **Notes**: File validates successfully. The documentation expected 7 agents but actual file has 6 agents (formatter, linter, security_scanner, code_reviewer, doc_writer, and default coordinator). This is a documentation issue, not a code issue.

### Scenario 5: Detect Undefined Agent Reference in delegate

- **Source**: Testing Guide Section 9.1 - "Validate `delegate` Reference to Undefined Agent"
- **Commands Executed**:
  ```bash
  poetry run streetrace check /tmp/dsl-test-agentic/undefined_delegate.sr
  ```
- **Expected**: `error[E0001]: undefined reference to agent 'nonexistent_agent'`
- **Actual**:
  ```
  error[E0001]: undefined reference to agent 'nonexistent_agent'
    --> /tmp/dsl-test-agentic/undefined_delegate.sr:10:2
       |
     9 |
    10 | agent coordinator:
       |  ^^^^
    11 |     instruction coordinator_instruction
       |
       = help: defined agents are: coordinator
  ```
- **Status**: PASS
- **Notes**: Error correctly detected with appropriate error code E0001 and help message.

### Scenario 6: Detect Circular Agent Reference

- **Source**: Testing Guide Section 9.2 - "Circular `use` Detection"
- **Commands Executed**:
  ```bash
  poetry run streetrace check /tmp/dsl-test-agentic/circular_reference.sr
  ```
- **Expected**: `error[E0011]: circular agent reference detected: agent_a -> agent_b -> agent_a`
- **Actual**:
  ```
  No mapping for semantic error code: E0011
  error: circular agent reference detected: agent_a -> agent_b -> agent_a
    --> /tmp/dsl-test-agentic/circular_reference.sr:10:2
  ```
- **Status**: PASS (with warning about missing error code mapping)
- **Notes**: Circular reference is correctly detected. However, there is a warning "No mapping for semantic error code: E0011" indicating that the error code formatting is incomplete. The error message itself is correct.

### Scenario 7: Warn for Agent with Both delegate and use

- **Source**: Testing Guide Section 9.2 - "Warning for Both delegate and use (W0002)"
- **Commands Executed**:
  ```bash
  poetry run streetrace check /tmp/dsl-test-agentic/both_delegate_use.sr
  ```
- **Expected**: `warning[W0002]: agent 'mixed' has both delegate and use - this is unusual` with exit code 0
- **Actual**:
  ```
  No mapping for semantic error code: W0002
  error: agent 'mixed' has both delegate and use - this is unusual
    --> /tmp/dsl-test-agentic/both_delegate_use.sr:22:2
  Found 1 error in /tmp/dsl-test-agentic/both_delegate_use.sr
  Exit code: 1
  ```
- **Status**: FAIL
- **Notes**: Two issues found:
  1. "No mapping for semantic error code: W0002" - error code formatting incomplete
  2. Reported as "error" instead of "warning" causing exit code 1 instead of 0

### Scenario 8: Code Generation - delegate Generates sub_agents

- **Source**: Testing Guide Section 9.5
- **Commands Executed**:
  ```bash
  poetry run streetrace dump-python agents/examples/dsl/coordinator.sr
  ```
- **Expected**: Generated Python contains `sub_agents=['code_expert', 'research_expert']`
- **Actual**: Generated Python contains:
  ```python
  'default': {
      'tools': ['fs'],
      'instruction': 'coordinator_prompt',
      'sub_agents': ['code_expert', 'research_expert'],
  },
  ```
- **Status**: PASS
- **Notes**: `delegate` keyword correctly generates `sub_agents` in agent configuration.

### Scenario 9: Code Generation - use Generates agent_tools

- **Source**: Testing Guide Section 9.5
- **Commands Executed**:
  ```bash
  poetry run streetrace dump-python agents/examples/dsl/hierarchical.sr
  ```
- **Expected**: Generated Python contains `agent_tools` with referenced agents
- **Actual**: Generated Python contains:
  ```python
  'default': {
      'tools': ['fs'],
      'instruction': 'orchestrator_prompt',
      'agent_tools': ['extractor', 'analyzer', 'documenter'],
  },
  ```
- **Status**: PASS
- **Notes**: `use` keyword correctly generates `agent_tools` in agent configuration.

### Scenario 10: Code Generation - loop Generates while Loop with Counter

- **Source**: Testing Guide Section 9.5
- **Commands Executed**:
  ```bash
  poetry run streetrace dump-python agents/examples/dsl/iterative.sr
  ```
- **Expected**: Generated Python contains while loop with `_loop_count` and `_max_iterations`
- **Actual**: Generated Python contains:
  ```python
  async def flow_refine_with_limit(self, ctx: WorkflowContext) -> Any:
      ctx.vars['current_code'] = ctx.vars['code']
      # agents/examples/dsl/iterative.sr:39
      _loop_count = 0
      _max_iterations = 5
      while _loop_count < _max_iterations:
          _loop_count += 1
          # ...
  ```
- **Status**: PASS
- **Notes**: `loop` block correctly generates bounded while loop with counter variable.

### Scenario 11: Python Compilation of Generated Code

- **Source**: Testing Guide Section 8.1
- **Commands Executed**:
  ```bash
  poetry run streetrace dump-python agents/examples/dsl/coordinator.sr -o /tmp/coordinator_generated.py
  python -m py_compile /tmp/coordinator_generated.py
  # (repeated for all 4 example files)
  ```
- **Expected**: All files compile without syntax errors
- **Actual**: All 4 files compile successfully
- **Status**: PASS
- **Notes**: coordinator.sr, hierarchical.sr, iterative.sr, and combined.sr all generate valid, compilable Python code.

### Scenario 12: E2E Runtime Test - Coordinator Pattern

- **Source**: Testing Guide Section 9.1 - "Coordinator E2E Execution"
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=/tmp/dsl-test-agentic/coordinator_e2e.sr \
      --model=anthropic/claude-sonnet-4-5 \
      --prompt="Analyze the file src/streetrace/main.py briefly"
  ```
- **Expected**: Agent runs and uses fs tools
- **Actual**: Agent ran successfully, used `read_file` tool, and provided analysis
- **Status**: PASS
- **Notes**: DSL agent loads and executes correctly at runtime. Note that the default example files use `anthropic/claude-sonnet` which is not a valid model name. Custom test file with `anthropic/claude-sonnet-4-5` was required.

### Scenario 13: E2E Runtime Test - Hierarchical Pattern

- **Source**: Testing Guide Section 9.2 - "Hierarchical E2E Execution"
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=/tmp/dsl-test-agentic/hierarchical_e2e.sr \
      --model=anthropic/claude-sonnet-4-5 \
      --prompt="Analyze this code briefly: def add(a, b): return a + b"
  ```
- **Expected**: Agent runs and may invoke helper agent as tool
- **Actual**: Agent ran successfully and responded. Helper agent tool was not invoked (LLM decided it was unnecessary for simple task)
- **Status**: PASS
- **Notes**: The hierarchical pattern loaded correctly. Agent tool invocation depends on LLM's decision.

### Scenario 14: Automated Test Suite - Agentic Patterns

- **Source**: Tests in `tests/dsl/`
- **Commands Executed**:
  ```bash
  poetry run pytest tests/dsl/test_agentic_patterns.py \
      tests/dsl/test_semantic_patterns.py \
      tests/dsl/test_codegen_patterns.py -v --no-header --timeout=30
  ```
- **Expected**: All pattern tests pass
- **Actual**: 71 passed in 2.66s
- **Status**: PASS
- **Notes**: All automated tests for agentic patterns pass.

### Scenario 15: Full DSL Test Suite

- **Source**: All tests in `tests/dsl/`
- **Commands Executed**:
  ```bash
  poetry run pytest tests/dsl/ -v --no-header --timeout=30 -q
  ```
- **Expected**: All DSL tests pass
- **Actual**: 643 passed in 58.35s
- **Status**: PASS
- **Notes**: Complete DSL test suite passes.

## Issues Found

### Issue 1: Missing Error Code Mapping for E0011 (Circular Reference)

- **Type**: Bug
- **Severity**: Low
- **Steps to Reproduce**:
  1. Create DSL file with circular agent reference
  2. Run `poetry run streetrace check circular_reference.sr`
- **Expected Behavior**: Error formatted as `error[E0011]: circular agent reference detected`
- **Actual Behavior**: Shows "No mapping for semantic error code: E0011" before the error message
- **Evidence**:
  ```
  No mapping for semantic error code: E0011
  error: circular agent reference detected: agent_a -> agent_b -> agent_a
  ```
- **Recommendation**: Add E0011 to the semantic error code mapping table in the error formatter.

### Issue 2: W0002 Warning Reported as Error

- **Type**: Bug
- **Severity**: Medium
- **Steps to Reproduce**:
  1. Create DSL file with agent having both `delegate` and `use` keywords
  2. Run `poetry run streetrace check both_delegate_use.sr`
- **Expected Behavior**: Warning `warning[W0002]` with exit code 0
- **Actual Behavior**: Error reported with exit code 1
- **Evidence**:
  ```
  No mapping for semantic error code: W0002
  error: agent 'mixed' has both delegate and use - this is unusual
  Found 1 error in /tmp/dsl-test-agentic/both_delegate_use.sr
  Exit code: 1
  ```
- **Recommendation**:
  1. Add W0002 to error code mapping
  2. Ensure warnings (W*) don't cause validation failure and return exit code 0

### Issue 3: Documentation Mismatch - combined.sr Agent Count

- **Type**: Documentation Mismatch
- **Severity**: Low
- **Steps to Reproduce**: Compare testing guide expected output with actual file
- **Expected Behavior**: Documentation states `valid (2 models, 7 agents, 1 flow)`
- **Actual Behavior**: File validates as `valid (2 models, 6 agents, 1 flow)`
- **Evidence**: Testing guide Section 9.6 states 7 agents, but combined.sr has 6 agents
- **Recommendation**: Update testing guide to reflect actual agent count of 6.

### Issue 4: Example DSL Files Use Invalid Model Names

- **Type**: Documentation/UX Problem
- **Severity**: Medium
- **Steps to Reproduce**:
  1. Run `poetry run streetrace --agent=agents/examples/dsl/coordinator.sr --model=anthropic/claude-sonnet-4-5 --prompt="test"`
- **Expected Behavior**: Agent runs with the model specified in CLI
- **Actual Behavior**: Agent uses model from DSL file (`anthropic/claude-sonnet`) which doesn't exist
- **Evidence**:
  ```
  LLM error: litellm.NotFoundError: AnthropicException -
  {"error":{"code":"DeploymentNotFound","message":"The API deployment
  claude-sonnet does not exist...
  ```
- **Recommendation**:
  1. Update example DSL files to use valid model names (e.g., `anthropic/claude-sonnet-4-5`)
  2. Consider allowing `--model` CLI flag to override DSL-defined models

## Summary

- **Total Scenarios**: 15
- **Passed**: 14
- **Failed**: 1 (W0002 warning treated as error)
- **Issues Found**: 4
  - 2 Bugs (E0011 mapping missing, W0002 treated as error)
  - 2 Documentation/UX issues (agent count mismatch, invalid model names in examples)

## Recommendations

### Priority 1 (High)

1. **Fix W0002 warning handling** - Warnings should not cause exit code 1. This affects CI/CD pipelines that may use `--strict` mode.

2. **Update example DSL files** - Change model names from `anthropic/claude-sonnet` to valid model names like `anthropic/claude-sonnet-4-5` so examples work out of the box.

### Priority 2 (Medium)

3. **Add error code mappings** - Complete the error code mapping for E0011 (circular reference) and W0002 (both delegate and use).

4. **Consider CLI model override** - Allow `--model` flag to override models defined in DSL files for testing purposes.

### Priority 3 (Low)

5. **Update testing documentation** - Fix the expected agent count for combined.sr from 7 to 6.

## Test Files Created

The following test files were created during this E2E test session:

- `/tmp/dsl-test-agentic/undefined_delegate.sr` - Tests undefined agent reference detection
- `/tmp/dsl-test-agentic/circular_reference.sr` - Tests circular reference detection
- `/tmp/dsl-test-agentic/both_delegate_use.sr` - Tests warning for mixed patterns
- `/tmp/dsl-test-agentic/coordinator_e2e.sr` - E2E test file with valid model
- `/tmp/dsl-test-agentic/hierarchical_e2e.sr` - E2E test file for hierarchical pattern
