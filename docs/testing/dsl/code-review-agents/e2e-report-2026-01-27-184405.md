# E2E Test Report: Code Review Agents DSL Features

**Date**: 2026-01-27 18:44:05 UTC
**Tester**: manual-e2e-tester agent
**Model Used**: anthropic/claude-sonnet-4-5 (not used for runtime - compilation tests only)

## Documentation Reviewed

- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/user/dsl/flow-control.md` - Flow control constructs (parallel do, for loops, conditionals)
- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/user/dsl/expressions.md` - Expressions (filter, property assignment, list concatenation)
- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/testing/dsl/code-review-agents/scenarios.md` - Test scenarios for code review agents

## Test Environment

- Working directory: `/home/data/repos/github.com/streetrace-ai/streetrace`
- Git branch: `feature/code-review-agent`
- Python environment: Poetry virtual environment
- Test scope: Compilation and code generation verification (no runtime execution requiring GitHub API)

## Test Scope and Limitations

The code review agents require GitHub API access for actual execution. This report focuses on:
1. **Parsing**: All three agent files parse without errors
2. **Compilation**: All three agent files compile to Python code
3. **Code patterns**: Generated code contains expected patterns for DSL features

---

## Scenarios Tested

### Scenario 1: Agent Files Parse Without Errors

**Source**: Documentation Phase 1 - All agents should parse correctly

| Agent | Parse Result | Status |
|-------|--------------|--------|
| v1-monolithic.sr | Tree root is 'start' | PASS |
| v2-parallel.sr | Tree root is 'start' | PASS |
| v3-hierarchical.sr | Tree root is 'start' | PASS |

**Commands Executed**:
```bash
poetry run pytest tests/dsl/test_code_review_agents.py::TestCodeReviewAgentsParsing -v
```

**Expected**: All parsing tests pass
**Actual**: 3/3 parsing tests passed
**Status**: PASS

---

### Scenario 2: Agent Files Transform to Valid AST

**Source**: Documentation Phase 1 - All agents should transform correctly

| Agent | Transform Result | Status |
|-------|------------------|--------|
| v1-monolithic.sr | Valid AST with statements | PASS |
| v2-parallel.sr | Valid AST with statements | PASS |
| v3-hierarchical.sr | Valid AST with statements | PASS |

**Commands Executed**:
```bash
poetry run pytest tests/dsl/test_code_review_agents.py::TestCodeReviewAgentsTransformation -v
```

**Expected**: All transformation tests pass
**Actual**: 3/3 transformation tests passed
**Status**: PASS

---

### Scenario 3: Agent Files Pass Semantic Validation

**Source**: Documentation Phase 1 - All agents should pass validation

| Agent | Validation Result | Status |
|-------|-------------------|--------|
| v1-monolithic.sr | No semantic errors | PASS |
| v2-parallel.sr | No semantic errors | PASS |
| v3-hierarchical.sr | No semantic errors | PASS |

**Commands Executed**:
```bash
poetry run pytest tests/dsl/test_code_review_agents.py::TestCodeReviewAgentsSemanticValidation -v
```

**Expected**: No semantic errors
**Actual**: Zero errors for all three agents
**Status**: PASS

---

### Scenario 4: Agent Files Generate Valid Python Code

**Source**: Documentation Phase 2 - All agents should generate executable Python

| Agent | Compilation Result | Bytecode Size | Source Mappings |
|-------|-------------------|---------------|-----------------|
| v1-monolithic.sr | SUCCESS | 170 bytes | 19 entries |
| v2-parallel.sr | SUCCESS | 170 bytes | 52 entries |
| v3-hierarchical.sr | SUCCESS | 170 bytes | 25 entries |

**Commands Executed**:
```bash
poetry run pytest tests/dsl/test_code_review_agents.py::TestCodeReviewAgentsCodeGeneration -v
```

**Expected**: Valid Python bytecode generated
**Actual**: All three agents compile to valid bytecode
**Status**: PASS

---

### Scenario 5: Parallel Block Compilation (V1 and V2)

**Source**: `scenarios.md` Scenario 1 - Parallel Block Execution

**Feature**: `parallel do` executes agents concurrently

**V1 DSL Input**:
```streetrace
parallel do
    $pr_info = run agent pr_fetcher $input
    $diff = run agent diff_fetcher $input
end
```

**V2 DSL Input**:
```streetrace
parallel do
    $security_findings = run agent security_reviewer_agent $full_context $chunk
    $bug_findings = run agent bug_reviewer_agent $full_context $chunk
    $style_findings = run agent style_reviewer_agent $full_context $chunk
end
```

**Expected Generated Code Pattern**:
- `_parallel_specs` list definition
- `_execute_parallel_agents` method call

**Actual V1 Generated Code** (lines 209-215):
```python
_parallel_specs = [
    ('pr_fetcher', [ctx.vars['input']]),
    ('diff_fetcher', [ctx.vars['input']]),
]
_parallel_results = await self._execute_parallel_agents(
    ctx, _parallel_specs)
```

**Actual V2 Generated Code** (lines 610-616):
```python
_parallel_specs = [
    ('security_reviewer_agent', [ctx.vars['full_context'], ctx.vars['chunk']]),
    ('bug_reviewer_agent', [ctx.vars['full_context'], ctx.vars['chunk']]),
    ('style_reviewer_agent', [ctx.vars['full_context'], ctx.vars['chunk']]),
]
_parallel_results = await self._execute_parallel_agents(
    ctx, _parallel_specs)
```

**Commands Executed**:
```bash
poetry run pytest tests/dsl/test_code_review_agents.py::TestV1MonolithicFeatures::test_contains_parallel_execution -v
poetry run pytest tests/dsl/test_code_review_agents.py::TestV2ParallelFeatures::test_contains_parallel_execution -v
```

**Status**: PASS

---

### Scenario 6: Filter Expression Compilation (V1 and V2)

**Source**: `scenarios.md` Scenario 2 - Filter Expression

**Feature**: `filter $list where .property >= value` filters lists

**V1 DSL Input**:
```streetrace
$filtered = filter $review.findings where .confidence >= 80
```

**V2 DSL Input** (multiple filters):
```streetrace
$high_confidence = filter $findings where .confidence >= 80
$fixable = filter $findings where .suggested_fix != null
```

**Expected Generated Code Pattern**:
- List comprehension with `_item` variable
- Condition checking property on `_item`

**Actual V1 Generated Code** (line 229):
```python
ctx.vars['filtered'] = [_item for _item in ctx.vars['review']['findings'] if (_item['confidence'] >= 80)]
```

**Actual V2 Generated Code** (lines 652, 671):
```python
ctx.vars['high_confidence'] = [_item for _item in ctx.vars['findings'] if (_item['confidence'] >= 80)]
ctx.vars['fixable'] = [_item for _item in ctx.vars['findings'] if (_item['suggested_fix'] != None)]
```

**Commands Executed**:
```bash
poetry run pytest tests/dsl/test_code_review_agents.py::TestV1MonolithicFeatures::test_contains_filter_comprehension -v
poetry run pytest tests/dsl/test_code_review_agents.py::TestV2ParallelFeatures::test_contains_filter_comprehension -v
```

**Status**: PASS

---

### Scenario 7: Property Assignment Compilation (V1)

**Source**: `scenarios.md` Scenario 4 - Property Assignment

**Feature**: `$obj.property = $value` assigns to object properties

**V1 DSL Input**:
```streetrace
$review.findings = $filtered
```

**Expected Generated Code Pattern**:
- `ctx.vars['review']['findings'] = ctx.vars['filtered']`

**Actual Generated Code** (line 230):
```python
ctx.vars['review']['findings'] = ctx.vars['filtered']
```

**Commands Executed**:
```bash
poetry run pytest tests/dsl/test_code_review_agents.py::TestV1MonolithicFeatures::test_contains_property_assignment -v
```

**Status**: PASS

---

### Scenario 8: List Concatenation Compilation (V2)

**Source**: `scenarios.md` Scenario 3 - List Concatenation

**Feature**: `$list + $list` concatenates lists

**V2 DSL Input**:
```streetrace
$all_findings = $all_findings + $security_findings.findings
$all_findings = $all_findings + $bug_findings.findings
$all_findings = $all_findings + $style_findings.findings
```

**Expected Generated Code Pattern**:
- `(ctx.vars['a'] + ctx.vars['b']['prop'])`

**Actual Generated Code** (lines 620-622):
```python
ctx.vars['all_findings'] = (ctx.vars['all_findings'] + ctx.vars['security_findings']['findings'])
ctx.vars['all_findings'] = (ctx.vars['all_findings'] + ctx.vars['bug_findings']['findings'])
ctx.vars['all_findings'] = (ctx.vars['all_findings'] + ctx.vars['style_findings']['findings'])
```

**Commands Executed**:
```bash
poetry run pytest tests/dsl/test_code_review_agents.py::TestV2ParallelFeatures::test_contains_list_concatenation -v
```

**Status**: PASS

---

### Scenario 9: Use Keyword for Sub-Agent Delegation (V3)

**Source**: `scenarios.md` - V3 uses `use` keyword for hierarchical delegation

**Feature**: `use agent1, agent2, ...` registers sub-agents as tools

**V3 DSL Input**:
```streetrace
agent:
    tools github, fs
    instruction orchestrator_instruction
    use context_builder, chunk_context_builder, security_specialist, bug_specialist, quality_specialist, validator, patch_generator, synthesizer
    description "Orchestrates code review using specialist agents as tools"
```

**Expected Generated Code Pattern**:
- `agent_tools` list containing sub-agent names

**Actual Generated Code** (line 409):
```python
'agent_tools': ['context_builder', 'chunk_context_builder', 'security_specialist', 'bug_specialist', 'quality_specialist', 'validator', 'patch_generator', 'synthesizer'],
```

**Commands Executed**:
```bash
poetry run pytest tests/dsl/test_code_review_agents.py::TestV3HierarchicalFeatures -v
```

**Status**: PASS

---

### Scenario 10: Invalid Parallel Block Error Handling

**Source**: `scenarios.md` Scenario 7.1 - Error Cases

**Feature**: Assignment statements should be rejected in parallel blocks

**Invalid DSL Input**:
```streetrace
streetrace v1

flow main:
    parallel do
        $x = 42
    end
```

**Expected Error**:
```
TypeError: parallel do only supports 'run agent' statements. Found: Assignment
```

**Actual Error**:
```
TypeError: parallel do only supports 'run agent' statements. Found: Assignment
```

**Note**: This validation occurs at code generation time (CodeGenerator), not during semantic validation. The documentation states the error message should appear during `streetrace check`, but it actually occurs during compilation/code generation.

**Commands Executed**:
```python
# Manual verification via Python
generator.generate(ast, 'test.sr')  # Raises TypeError
```

**Status**: PASS (error message matches documentation)

---

### Scenario 11: Full Test Suite Execution

**Source**: All test scenarios combined

**Commands Executed**:
```bash
poetry run pytest tests/dsl/test_code_review_agents.py -v --no-header --timeout=30
```

**Expected**: All 30 tests pass
**Actual**: 30/30 tests passed in 6.46s
**Status**: PASS

**Test Breakdown**:
- `TestCodeReviewAgentsParsing`: 3 tests - PASS
- `TestCodeReviewAgentsTransformation`: 3 tests - PASS
- `TestCodeReviewAgentsSemanticValidation`: 3 tests - PASS
- `TestCodeReviewAgentsCodeGeneration`: 3 tests - PASS
- `TestV1MonolithicFeatures`: 3 tests - PASS
- `TestV2ParallelFeatures`: 3 tests - PASS
- `TestV3HierarchicalFeatures`: 2 tests - PASS
- `TestCodeReviewAgentsDslSourceFeatures`: 7 tests - PASS
- `TestCodeReviewAgentsCompileEnd2End`: 3 tests - PASS

---

## Issues Found

### Issue 1: Documentation Mismatch - Error Timing

**Type**: Documentation Mismatch
**Severity**: Low

**Description**: The test scenarios document (Scenario 7.1) suggests using `streetrace check` to validate invalid parallel blocks. However, the actual validation happens during code generation (in `CodeGenerator`), not during semantic validation.

**Steps to Reproduce**:
1. Create a file with invalid parallel block content
2. Run semantic validation - no errors reported
3. Run code generation - TypeError raised

**Expected Behavior**: `streetrace check` command should report the error
**Actual Behavior**: Error is raised during code generation, not semantic validation

**Evidence**:
```python
# Semantic validation returns no errors
diagnostics = validate_dsl(invalid_source, 'test.sr')
len(diagnostics)  # Returns 0

# Code generation raises TypeError
generator.generate(ast, 'test.sr')
# TypeError: parallel do only supports 'run agent' statements. Found: Assignment
```

**Recommendation**: Either:
1. Move parallel block validation to semantic validator for earlier detection, or
2. Update documentation to clarify that the error occurs during compilation/code generation

---

## Summary

| Metric | Count |
|--------|-------|
| Total Scenarios | 11 |
| Passed | 11 |
| Failed | 0 |
| Issues Found | 1 (Low severity) |
| Documentation Gaps | 1 |

## Detailed Test Results

| Test Category | Tests | Status |
|---------------|-------|--------|
| Parsing (all 3 agents) | 3 | PASS |
| Transformation (all 3 agents) | 3 | PASS |
| Semantic Validation (all 3 agents) | 3 | PASS |
| Code Generation (all 3 agents) | 3 | PASS |
| V1 Feature Patterns | 3 | PASS |
| V2 Feature Patterns | 3 | PASS |
| V3 Feature Patterns | 2 | PASS |
| DSL Source Patterns | 7 | PASS |
| E2E Compilation | 3 | PASS |
| **Total** | **30** | **PASS** |

## Recommendations

### Priority 1: Low - Consider Moving Validation Earlier

The invalid parallel block validation could be moved from code generation to semantic validation phase. This would:
- Provide earlier feedback to users
- Make `streetrace check` more useful for catching this error
- Align with user expectations from documentation

### Priority 2: Informational - Update Documentation

If the validation timing is intentional, update `scenarios.md` Scenario 7.1 to clarify that the error occurs during compilation rather than during `streetrace check`.

---

## Conclusion

All DSL features for code review agents compile correctly and generate the expected Python code patterns:

1. **Parallel blocks** generate `_parallel_specs` and `_execute_parallel_agents` calls
2. **Filter expressions** generate list comprehensions with `_item` iteration variable
3. **Property assignment** generates correct nested dictionary access
4. **List concatenation** generates Python `+` operator expressions
5. **Use keyword** generates `agent_tools` list for sub-agent delegation

The implementation matches the documented behavior with one minor documentation mismatch regarding error timing for invalid parallel block content.
