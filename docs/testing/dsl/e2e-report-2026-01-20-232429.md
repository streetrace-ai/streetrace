# E2E Test Report: DSL Compiler Feature (017-dsl-compiler)

**Date**: 2026-01-20T23:24:29
**Tester**: manual-e2e-tester agent
**Model Used**: anthropic/claude-sonnet-4-5

## Documentation Reviewed

- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/testing/dsl/017-dsl-compiler-testing.md`
- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/user/dsl/getting-started.md`
- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/user/dsl/syntax-reference.md`

## Test Environment

- **Working Directory**: `/home/data/repos/github.com/streetrace-ai/streetrace`
- **Branch**: `feature/017-streetrace-dsl-2`
- **Platform**: Linux 6.1.146-1-MANJARO
- **Python**: Poetry managed environment

---

## Scenarios Tested

### 1. CLI Command Availability

#### Scenario 1.1: `streetrace check --help`
- **Source**: Section 1.1 (Environment Setup)
- **Commands Executed**: `poetry run streetrace check --help`
- **Expected**: Help output showing usage, arguments, and options
- **Actual**:
  ```
  usage: streetrace check [-h] [-v] [--format {text,json}] [--strict] path

  Validate Streetrace DSL files

  positional arguments:
    path                  DSL file or directory to validate

  options:
    -h, --help            show this help message and exit
    -v, --verbose         Enable verbose output
    --format {text,json}  Output format (default: text)
    --strict              Treat warnings as errors
  ```
- **Status**: PASS

#### Scenario 1.2: `streetrace dump-python --help`
- **Source**: Section 1.1 (Environment Setup)
- **Commands Executed**: `poetry run streetrace dump-python --help`
- **Expected**: Help output with usage, arguments, and options
- **Actual**:
  ```
  usage: streetrace dump-python [-h] [--no-comments] [-o OUTPUT] path

  Generate Python code from DSL file

  positional arguments:
    path                  DSL file to convert

  options:
    -h, --help            show this help message and exit
    --no-comments         Exclude source comments from output
    -o OUTPUT, --output OUTPUT
                          Output file path (default: stdout)
  ```
- **Status**: PASS

---

### 2. Example DSL File Validation

#### Scenario 2.1: Minimal Agent (`minimal.sr`)
- **Source**: Section 3.1
- **Commands Executed**: `poetry run streetrace check agents/examples/dsl/minimal.sr`
- **Expected**: `valid (1 model, 1 agent)`
- **Actual**: `valid (1 model, 1 agent)`
- **Status**: PASS

#### Scenario 2.2: Handlers Example (`handlers.sr`)
- **Source**: Section 3.2
- **Commands Executed**: `poetry run streetrace check agents/examples/dsl/handlers.sr`
- **Expected**: `valid (1 model, 1 agent, 2 handlers)`
- **Actual**: `valid (1 model, 1 agent, 2 handlers)`
- **Status**: PASS

#### Scenario 2.3: Flow Example (`flow.sr`)
- **Source**: Section 3.3
- **Commands Executed**: `poetry run streetrace check agents/examples/dsl/flow.sr`
- **Expected**: `valid (1 model, 2 agents)` (per documentation)
- **Actual**: `valid (2 models, 3 agents, 1 flow)`
- **Status**: PASS (documentation stats outdated but file is valid)
- **Notes**: Documentation shows different file content than actual file. Actual file has 2 models, 3 agents, 1 flow.

#### Scenario 2.4: Parallel Example (`parallel.sr`)
- **Source**: Section 3.4
- **Commands Executed**: `poetry run streetrace check agents/examples/dsl/parallel.sr`
- **Expected**: `valid (1 model, 2 agents)` (per documentation)
- **Actual**: `valid (1 model, 4 agents, 1 flow)`
- **Status**: PASS (documentation stats outdated but file is valid)
- **Notes**: Documentation shows different file content. Actual file has 4 agents and 1 flow.

#### Scenario 2.5: Schema Example (`schema.sr`)
- **Source**: Section 3.5
- **Commands Executed**: `poetry run streetrace check agents/examples/dsl/schema.sr`
- **Expected**: `valid (1 model, 4 agents)`
- **Actual**: `valid (1 model, 4 agents)`
- **Status**: PASS

#### Scenario 2.6: Policies Example (`policies.sr`)
- **Source**: Section 3.6
- **Commands Executed**: `poetry run streetrace check agents/examples/dsl/policies.sr`
- **Expected**: `valid (2 models, 3 agents)`
- **Actual**: `valid (2 models, 3 agents)`
- **Status**: PASS

#### Scenario 2.7: Match Example (`match.sr`)
- **Source**: Section 3.7
- **Commands Executed**: `poetry run streetrace check agents/examples/dsl/match.sr`
- **Expected**: `valid (1 model, 2 agents)`
- **Actual**: `valid (1 model, 7 agents, 1 flow)`
- **Status**: PASS (documentation stats outdated but file is valid)
- **Notes**: Actual file has 7 agents and 1 flow.

#### Scenario 2.8: Complete Example (`complete.sr`)
- **Source**: Section 3.8
- **Commands Executed**: `poetry run streetrace check agents/examples/dsl/complete.sr`
- **Expected**: `valid (2 models, 2 agents, 2 handlers)`
- **Actual**: `valid (2 models, 2 agents, 2 handlers)`
- **Status**: PASS

---

### 3. Production Agent Validation

#### Scenario 3.1: Generic Agent (`generic.sr`)
- **Source**: Section 3.9
- **Commands Executed**: `poetry run streetrace check agents/generic.sr`
- **Expected**: `valid (1 model, 1 agent)`
- **Actual**: `valid (1 model, 1 agent)`
- **Status**: PASS

#### Scenario 3.2: Reviewer Agent (`reviewer.sr`)
- **Source**: Section 3.9
- **Commands Executed**: `poetry run streetrace check agents/reviewer.sr`
- **Expected**: `valid (1 model, 1 agent)`
- **Actual**: `valid (1 model, 1 agent)`
- **Status**: PASS

#### Scenario 3.3: Orchestrator Agent (`orchestrator.sr`)
- **Source**: Section 3.9
- **Commands Executed**: `poetry run streetrace check agents/orchestrator.sr`
- **Expected**: `valid (1 model, 1 agent)`
- **Actual**: `valid (1 model, 1 agent)`
- **Status**: PASS

---

### 4. Output Format Testing

#### Scenario 4.1: JSON Output Format
- **Source**: Section 2.1
- **Commands Executed**: `poetry run streetrace check agents/examples/dsl/minimal.sr --format json`
- **Expected**: JSON with version, file, valid, errors, warnings, stats
- **Actual**:
  ```json
  {
    "version": "1.0",
    "file": "agents/examples/dsl/minimal.sr",
    "valid": true,
    "errors": [],
    "warnings": [],
    "stats": {
      "models": 1,
      "agents": 1,
      "flows": 0,
      "handlers": 0
    }
  }
  ```
- **Status**: PASS

#### Scenario 4.2: Verbose Output
- **Source**: Section 2.1
- **Commands Executed**: `poetry run streetrace check agents/examples/dsl/minimal.sr --verbose`
- **Expected**: Output with full file path prefix
- **Actual**: `agents/examples/dsl/minimal.sr: valid (1 model, 1 agent)`
- **Status**: PASS

---

### 5. Directory Validation

#### Scenario 5.1: Validate Directory
- **Source**: Section 3.10
- **Commands Executed**: `poetry run streetrace check agents/examples/dsl/ --verbose`
- **Expected**: All 11 files should report as valid (8 example + 3 production per docs)
- **Actual**: 9 files validated, all valid:
  ```
  agents/examples/dsl/minimal.sr: valid (1 model, 1 agent)
  agents/examples/dsl/schema.sr: valid (1 model, 4 agents)
  agents/examples/dsl/specific_model.sr: valid (2 models, 1 agent)
  agents/examples/dsl/parallel.sr: valid (1 model, 4 agents, 1 flow)
  agents/examples/dsl/complete.sr: valid (2 models, 2 agents, 2 handlers)
  agents/examples/dsl/handlers.sr: valid (1 model, 1 agent, 2 handlers)
  agents/examples/dsl/policies.sr: valid (2 models, 3 agents)
  agents/examples/dsl/flow.sr: valid (2 models, 3 agents, 1 flow)
  agents/examples/dsl/match.sr: valid (1 model, 7 agents, 1 flow)
  ```
- **Status**: PASS
- **Notes**: Documentation mentions 8 example files; found 9 (includes `specific_model.sr`). Production files are in different directory.

---

### 6. `dump-python` Command Testing

#### Scenario 6.1: Dump to Stdout
- **Source**: Section 2.2
- **Commands Executed**: `poetry run streetrace dump-python agents/examples/dsl/minimal.sr`
- **Expected**: Python code with class definition, source comments
- **Actual**: Generated valid Python class `AgentsExamplesDslMinimalWorkflow` with `_models`, `_prompts`, `_agents` dictionaries
- **Status**: PASS

#### Scenario 6.2: Dump Without Comments
- **Source**: Section 2.2
- **Commands Executed**: `poetry run streetrace dump-python agents/examples/dsl/minimal.sr --no-comments`
- **Expected**: Python code without `# filename:line` comments
- **Actual**: Generated code without source line comments
- **Status**: PASS

#### Scenario 6.3: Dump to File
- **Source**: Section 2.2
- **Commands Executed**: `poetry run streetrace dump-python agents/examples/dsl/minimal.sr -o /tmp/generated.py`
- **Expected**: `wrote: /tmp/generated.py` and valid Python
- **Actual**: `wrote: /tmp/generated.py`, Python compiles successfully with `py_compile`
- **Status**: PASS

#### Scenario 6.4: Complete Example Code Generation
- **Source**: Section 8.1
- **Commands Executed**:
  ```
  poetry run streetrace dump-python agents/examples/dsl/complete.sr -o /tmp/complete.py
  python -m py_compile /tmp/complete.py
  ```
- **Expected**: Valid Python code
- **Actual**: Python compiles successfully
- **Status**: PASS

---

### 7. Error Handling Testing

#### Scenario 7.1: File Not Found
- **Source**: Section 2.1
- **Commands Executed**: `poetry run streetrace check nonexistent.sr`
- **Expected**: `error: file not found: nonexistent.sr`, Exit code 2
- **Actual**: `error: file not found: nonexistent.sr`, Exit code 2
- **Status**: PASS

#### Scenario 7.2: Missing Colon Syntax Error
- **Source**: Section 4.1
- **Commands Executed**: Created file without colon after `agent`, ran check
- **Expected**: Error about unexpected token, expected `:`
- **Actual**:
  ```
  error[E0007]: unexpected token '
      '
    --> /tmp/dsl-test/missing_colon.sr:5:7
       |
     4 |
     5 | agent
       | ^
     6 |     tools fs
       |
       = help: expected one of: COLON, NAME
  ```
- **Status**: PASS

#### Scenario 7.3: Unterminated `do/end` Block
- **Source**: Section 4.1
- **Commands Executed**: Created file with missing `end`, ran check
- **Expected**: Error about unexpected end of input or missing `end`
- **Actual**:
  ```
  error[E0007]: unexpected token 'agent'
    --> /tmp/dsl-test/unterminated_block.sr:8:2
       |
     7 |
     8 | agent:
       |  ^^^^^
       = help: expected one of: END
  ```
- **Status**: PASS

#### Scenario 7.4: Undefined Model Reference (E0001)
- **Source**: Section 4.2
- **Commands Executed**: Created file referencing undefined model
- **Expected**: Error E0001 with suggestion of defined models
- **Actual**:
  ```
  error[E0001]: undefined reference to model 'undefined_model'
    --> /tmp/dsl-test/undefined_model.sr:3:2
       = help: defined models are: main
  ```
- **Status**: PASS

#### Scenario 7.5: Duplicate Definition (E0003)
- **Source**: Section 4.2
- **Commands Executed**: Created file with duplicate model definition
- **Expected**: Error E0003 about duplicate definition
- **Actual**:
  ```
  error[E0003]: duplicate definition of model 'main'
    --> /tmp/dsl-test/duplicate_def.sr:2:2
  ```
- **Status**: PASS

#### Scenario 7.6: Missing Required Property (E0010)
- **Source**: Section 5 (Error Code Table)
- **Commands Executed**: Created agent without `instruction` property
- **Expected**: Error E0010 about missing required property
- **Actual**:
  ```
  error[E0010]: missing required property 'instruction' in agent 'helper'
    --> /tmp/dsl-test/missing_instruction.sr:5:2
       = help: add 'instruction <prompt_name>' to specify the agent's instruction prompt
  ```
- **Status**: PASS

---

### 8. Special File Cases

#### Scenario 8.1: Empty File
- **Source**: Section 4.3
- **Commands Executed**: Created empty `.sr` file, ran check
- **Expected**: Either succeeds with 0 definitions or meaningful error
- **Actual**: `valid`, Exit code 0
- **Status**: PASS

#### Scenario 8.2: Comments Only File
- **Source**: Section 4.3
- **Commands Executed**: Created file with only comments
- **Expected**: Should succeed (valid DSL with 0 definitions)
- **Actual**: `valid`, Exit code 0
- **Status**: PASS

#### Scenario 8.3: Unicode Content in Prompts
- **Source**: Section 4.3
- **Commands Executed**: Created file with Chinese characters in prompt
- **Expected**: Should parse and validate successfully
- **Actual**: `valid (1 model, 1 agent)`
- **Status**: PASS

---

### 9. Known Issue Testing (Section 9)

#### Scenario 9.1: Comma-Separated Name Lists (Issue 9.1)
- **Source**: Section 9.1
- **Commands Executed**: Created agent with `tools fs, cli`
- **Expected per documentation**: Error `undefined reference to tool ','`
- **Actual**: `valid (1 model, 1 agent)` - Issue appears to be FIXED
- **Status**: FIXED (documentation needs update)
- **Notes**: Generated code shows `'tools': ['fs', 'cli']` - correctly parsed as two tools.

#### Scenario 9.2: Flow Parameter Variable Scoping (Issue 9.2)
- **Source**: Section 9.2
- **Commands Executed**: Created flow with parameter `$input`
- **Expected per documentation**: Error about variable used before definition
- **Actual**: `valid (1 model, 1 agent, 1 flow)` - Issue appears to be FIXED
- **Status**: FIXED (documentation needs update)

#### Scenario 9.3: Policy Property Transformation (Issue 9.3)
- **Source**: Section 9.3
- **Commands Executed**: Created file with complex policy block
- **Expected per documentation**: `unhashable type` or transformation errors
- **Actual**: `valid (1 model, 1 agent)` - Issue appears to be FIXED
- **Status**: FIXED (documentation needs update)

#### Scenario 9.5: Runtime Integration (Issue 9.5)
- **Source**: Section 9.5
- **Commands Executed**: `poetry run streetrace --agent /tmp/dsl-test/runtime_test.sr --model=anthropic/claude-sonnet-4-5 --prompt "Say hello"`
- **Expected per documentation**: Error about unsupported agent format
- **Actual**: Agent loaded and executed successfully, received "Hello! How can I help you today?"
- **Status**: FIXED (documentation needs update)
- **Notes**: The DSL agent integration with `--agent` flag now works correctly.

---

### 10. Flow Call Validation

#### Scenario 10.1: Flow Calling Another Flow
- **Source**: Section 3.11 and syntax-reference.md
- **Commands Executed**: Created file with `run test_flow` syntax to call a user-defined flow
- **Expected**: Should validate successfully (per syntax-reference.md line 512)
- **Actual**: `valid (1 model, 1 agent, 2 flows)`
- **Status**: PASS
- **Notes**: Fix verified on 2026-01-20. The `_validate_run_stmt()` method in `analyzer.py` now correctly checks `stmt.is_flow` and validates against defined flows instead of agents.

---

## Issues Found

### Issue 1: Flow Calls Incorrectly Validated as Agent Calls - FIXED

- **Type**: Bug
- **Severity**: High
- **Status**: FIXED (verified 2026-01-20)
- **Fix Location**: `src/streetrace/dsl/semantic/analyzer.py`, method `_validate_run_stmt()` (lines 512-534)
- **Fix Description**: The method now checks `stmt.is_flow` attribute and validates against `self._symbols.flows` when true, otherwise validates against `self._symbols.agents`.
- **Verification**: Created test file with flow-to-flow call (`run test_flow`), validation passes with output `valid (1 model, 1 agent, 2 flows)`.

### Issue 2: Documentation Statistics Mismatch

- **Type**: Documentation Mismatch
- **Severity**: Low
- **Steps to Reproduce**: Compare expected outputs in testing documentation with actual file contents
- **Expected Behavior**: Documentation should match actual example files
- **Actual Behavior**: Several example files have different statistics than documented:
  - `flow.sr`: Doc says "2 agents", actual has "3 agents, 1 flow"
  - `parallel.sr`: Doc says "2 agents", actual has "4 agents, 1 flow"
  - `match.sr`: Doc says "2 agents", actual has "7 agents, 1 flow"
- **Recommendation**: Update the testing documentation section 3 to match actual example file contents.

### Issue 3: Known Issues Section Outdated

- **Type**: Documentation Mismatch
- **Severity**: Medium
- **Steps to Reproduce**: Test the scenarios documented in Section 9 (Known Issues)
- **Expected Behavior**: Issues 9.1, 9.2, 9.3, and 9.5 should reproduce as documented
- **Actual Behavior**: All four tested issues (9.1, 9.2, 9.3, 9.5) appear to be FIXED
- **Recommendation**: Remove or update Section 9 to reflect that these issues are resolved. Consider adding the new flow call validation issue (Issue 1 above).

---

## Summary

| Metric | Count |
|--------|-------|
| Total Scenarios Tested | 24 |
| Passed | 24 |
| Failed | 0 |
| Issues Found | 3 (1 fixed, 2 documentation) |
| Documentation Gaps | 2 |

### Pass/Fail Breakdown

| Category | Passed | Failed |
|----------|--------|--------|
| CLI Commands | 2/2 | 0 |
| Example Validation | 8/8 | 0 |
| Production Agents | 3/3 | 0 |
| Output Formats | 2/2 | 0 |
| Directory Validation | 1/1 | 0 |
| dump-python | 4/4 | 0 |
| Error Handling | 6/6 | 0 |
| Special Files | 3/3 | 0 |
| Known Issues (Section 9) | 4/4 | 0 |
| Flow Calls | 1/1 | 0 |

---

## Recommendations

### Priority 1 (Medium)

1. **Update Section 9 (Known Issues)**: Remove or mark as fixed:
   - Issue 9.1 (Comma-Separated Name Lists) - FIXED
   - Issue 9.2 (Flow Parameter Variable Scoping) - FIXED
   - Issue 9.3 (Policy Property Transformation) - FIXED
   - Issue 9.5 (Runtime Integration) - FIXED

### Priority 2 (Low)

2. **Update example statistics in documentation**: Correct the expected output values in Section 3 to match actual file contents.

### Completed

- **Flow call validation bug (Issue 1)**: FIXED on 2026-01-20. The `_validate_run_stmt()` method now correctly validates flow calls against defined flows.

---

## Test Artifacts

- **Test files created**: `/tmp/dsl-test/` directory containing:
  - `missing_colon.sr`
  - `unterminated_block.sr`
  - `undefined_model.sr`
  - `duplicate_def.sr`
  - `missing_instruction.sr`
  - `empty.sr`
  - `comments_only.sr`
  - `unicode.sr`
  - `comma_test.sr`
  - `flow_test.sr`
  - `policy_test.sr`
  - `runtime_test.sr`
  - `simple_flow_call.sr`

- **Generated Python files**: `/tmp/generated.py`, `/tmp/complete.py`

---

## See Also

- [017-dsl-compiler-testing.md](/home/data/repos/github.com/streetrace-ai/streetrace/docs/testing/dsl/017-dsl-compiler-testing.md) - Source testing documentation
- [DSL Syntax Reference](/home/data/repos/github.com/streetrace-ai/streetrace/docs/user/dsl/syntax-reference.md) - DSL syntax documentation
- [Semantic Analyzer](/home/data/repos/github.com/streetrace-ai/streetrace/src/streetrace/dsl/semantic/analyzer.py) - Contains flow call validation fix
