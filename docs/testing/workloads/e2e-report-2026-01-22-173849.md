# E2E Test Report: Workload Abstraction

**Date**: 2026-01-22 17:38:49 UTC
**Tester**: manual-e2e-tester agent
**Model Used**: anthropic/claude-sonnet-4-5

## Documentation Reviewed

- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/user/workloads/getting-started.md` - User documentation for Workloads
- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/user/workloads/examples.md` - Workload examples
- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/user/workloads/configuration.md` - Workload configuration
- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/user/workloads/troubleshooting.md` - Troubleshooting guide
- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/testing/workloads/testing-guide.md` - Testing guide with scenarios
- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/testing/workloads/scenarios.md` - Test scenarios for workload abstraction
- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/testing/workloads/environment-setup.md` - Test environment setup

## Test Environment

- **Working directory**: `/home/data/repos/github.com/streetrace-ai/streetrace`
- **Branch**: `feature/017-streetrace-dsl-2`
- **Python version**: 3.12 (via poetry)
- **Log file**: `./streetrace.log` (cleared before each test)
- **Test agents created in**: `./agents/test_workloads/`

## Scenarios Tested

### Scenario 1: DSL Compile-on-Load

- **Source**: Testing scenarios.md - Scenario 1
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=agents/test_workloads/basic_dsl.sr --model=anthropic/claude-sonnet-4-5 --prompt="Hello" --verbose
  ```
- **Expected**: DSL file is compiled during load, logs show compile activity
- **Actual**: Agent loaded and responded "DSL agent responding."
- **Status**: PASS
- **Notes**: Logs confirmed compile-on-load behavior:
  ```
  Loading DSL agent from agents/test_workloads/basic_dsl.sr
  Compiling DSL file: agents/test_workloads/basic_dsl.sr
  Generated 44 lines of code with 3 source mappings
  ```

---

### Scenario 2: DSL Syntax Error Rejection

- **Source**: Testing scenarios.md - Scenario 2
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=agents/test_workloads/invalid_syntax.sr --model=anthropic/claude-sonnet-4-5 --prompt="Hello"
  ```
- **Expected**: Error during loading with clear syntax error message
- **Actual**: Error correctly caught with message:
  ```
  Failed to load from agents/test_workloads/invalid_syntax.sr: Syntax error in
  agents/test_workloads/invalid_syntax.sr: Unexpected token Token('_NL', '\n    ')
  at line 6, column 16.
  Expected one of:
          * USING
          * INHERIT
          * COLON
          * EXPECTING
  ```
- **Status**: PASS
- **Notes**: Error is caught during load, not during execution. Line number and expected tokens are provided.

---

### Scenario 3: YAML Definition Loading

- **Source**: Testing scenarios.md - Scenario 3
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=yaml_test_agent --model=anthropic/claude-sonnet-4-5 --prompt="Hello" --verbose
  ```
- **Expected**: YAML agent is parsed and loaded
- **Actual**: Agent loaded and responded "YAML agent responding."
- **Status**: PASS
- **Notes**: Logs confirmed:
  ```
  Discovered agent 'yaml_test_agent' (yaml) in cwd
  Loading agent 'yaml_test_agent' (yaml) from cwd
  ```

---

### Scenario 4: Python Definition Loading

- **Source**: Testing scenarios.md - Scenario 4
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=basic_python_agent --model=anthropic/claude-sonnet-4-5 --prompt="Hello" --verbose
  ```
- **Expected**: Python agent module is imported and validated
- **Actual**: Agent loaded and responded "Python agent responding."
- **Status**: PASS
- **Notes**: Logs confirmed:
  ```
  Discovered agent 'basic_python_agent' (python) in cwd
  Loading agent 'basic_python_agent' (python) from cwd
  ```

---

### Scenario 5: WorkloadMetadata Immutability

- **Source**: Testing scenarios.md - Scenario 5
- **Commands Executed**:
  ```python
  definition = loader.load(test_file)
  definition.metadata.name = "changed"  # Should fail
  ```
- **Expected**: Mutation attempt raises FrozenInstanceError
- **Actual**: Mutation blocked with FrozenInstanceError
- **Status**: PASS
- **Notes**: Verified that `WorkloadMetadata` is a frozen dataclass with `frozen=True`

---

### Scenario 6: WorkloadDefinition Required Fields

- **Source**: Testing scenarios.md - Scenario 6
- **Commands Executed**:
  ```python
  definition = loader.load(path)
  print(f"workflow_class is None: {definition.workflow_class is None}")
  ```
- **Expected**: workflow_class is never None after successful load
- **Actual**: workflow_class correctly populated
- **Status**: PASS
- **Notes**: `DslWorkloadDefinition` always has `workflow_class` populated after successful compilation

---

### Scenario 7: DefinitionLoader Protocol Compliance

- **Source**: Testing scenarios.md - Scenario 7
- **Commands Executed**:
  ```python
  isinstance(DslDefinitionLoader(), DefinitionLoader)
  isinstance(YamlDefinitionLoader(), DefinitionLoader)
  isinstance(PythonDefinitionLoader(), DefinitionLoader)
  ```
- **Expected**: All loaders implement the DefinitionLoader protocol
- **Actual**: All three loaders pass isinstance check for DefinitionLoader
- **Status**: PASS
- **Notes**: All loaders have `can_load()`, `load()`, and `discover()` methods

---

### Scenario 8: WorkloadManager discover_definitions()

- **Source**: Testing scenarios.md - Scenario 8
- **Commands Executed**:
  ```python
  manager = WorkloadManager(...)
  definitions = manager.discover_definitions()
  ```
- **Expected**: Returns list of WorkloadDefinition objects
- **Actual**: Found 2 definitions (DSL and YAML) with correct types
- **Status**: PASS
- **Notes**: Output:
  ```
  Found 2 definitions
    test_dsl (dsl): DslWorkloadDefinition
      Is WorkloadDefinition: True
    test_yaml (yaml): YamlWorkloadDefinition
      Is WorkloadDefinition: True
  ```

---

### Scenario 9: WorkloadNotFoundError

- **Source**: Testing scenarios.md - Scenario 9
- **Commands Executed**:
  ```python
  manager.create_workload_from_definition("nonexistent_agent")
  ```
- **Expected**: WorkloadNotFoundError raised with name attribute
- **Actual**: WorkloadNotFoundError raised correctly
- **Status**: PASS
- **Notes**: Exception includes `name` attribute and clear message:
  ```
  OK: WorkloadNotFoundError raised
    name attribute: nonexistent_agent
    message: Workload 'nonexistent_agent' not found
  ```

---

### Scenario 10: End-to-End DSL Workload Execution

- **Source**: Testing scenarios.md - Scenario 10
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=agents/test_workloads/e2e_test.sr --model=anthropic/claude-sonnet-4-5 --prompt="Hello" --verbose
  ```
- **Expected**: DSL file is loaded, compiled, and executed
- **Actual**: Workload executed successfully, instruction passed to LLM
- **Status**: PASS
- **Notes**: Logs showed correct compile and execution path:
  ```
  Compiling DSL file: agents/test_workloads/e2e_test.sr
  Loaded workflow class AgentsTestWorkloadsE2eTestWorkflow
  ```

  The instruction "Respond with: E2E test successful" was correctly passed to the LLM in the system message. The LLM chose not to follow it exactly (LLM behavior issue, not workload system issue).

---

### Scenario 11: Backward Compatibility - Bundled Python Agent

- **Source**: Testing scenarios.md - Scenario 11
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=Streetrace_Coding_Agent --model=anthropic/claude-sonnet-4-5 --prompt="Say hello briefly in one sentence"
  ```
- **Expected**: Bundled Python agent works through existing context manager
- **Actual**: Agent responded correctly
- **Status**: PASS
- **Notes**: Bundled agents continue to work with the new workload abstraction

---

### Scenario 12: Agent Discovery (--list-agents)

- **Source**: Testing guide - Scenario 9
- **Commands Executed**:
  ```bash
  poetry run streetrace --list-agents
  ```
- **Expected**: Lists all discovered agents with type and location
- **Actual**: Listed all agents correctly
- **Status**: PASS
- **Notes**: Output shows Name, Type, Description, and Location columns:
  ```
  Name                     Type   Description             Location
  yaml_test_agent          yaml   Test YAML agent...      /home/data/repos/...
  basic_python_agent      python  Basic Python test...    Built-in
  Streetrace_Coding_Age...python  A peer engineer agent   Built-in
  ```

---

## Issues Found

### Issue 1: Documentation Gap - streetrace v1 Header

- **Type**: Documentation Mismatch
- **Severity**: Low
- **Details**:
  - The user documentation (`getting-started.md`, `examples.md`) shows DSL files with `streetrace v1` header
  - However, the existing test agents in `agents/examples/workloads/` do NOT have this header
  - Both versions work correctly (with and without header)
- **Expected Behavior**: Documentation should match actual implementation
- **Recommendation**: Either remove `streetrace v1` from documentation examples, or update all existing DSL files to include it for consistency

---

### Issue 2: Documentation Gap - Python Agent StreetRaceAgentCard

- **Type**: Documentation Mismatch
- **Severity**: Medium
- **Details**:
  - The user documentation (`getting-started.md`, `examples.md`) shows a simple `StreetRaceAgentCard` with only `name` and `description` fields
  - The actual implementation requires additional fields: `version`, `defaultInputModes`, `defaultOutputModes`, `capabilities`, `skills`
  - Example from docs:
    ```python
    return StreetRaceAgentCard(
        name="my_python_agent",
        description="A helpful Python-defined assistant",
    )
    ```
  - Actual requirement:
    ```python
    return StreetRaceAgentCard(
        name="basic_python_agent",
        description="...",
        version="1.0.0",
        defaultInputModes=["text"],
        defaultOutputModes=["text"],
        capabilities=AgentCapabilities(streaming=True),
        skills=[skill],
    )
    ```
- **Evidence**: Pydantic validation errors when following documentation:
  ```
  pydantic_core._pydantic_core.ValidationError: 5 validation errors for StreetRaceAgentCard
  capabilities - Field required
  defaultInputModes - Field required
  defaultOutputModes - Field required
  skills - Field required
  version - Field required
  ```
- **Recommendation**: Update documentation to show complete `StreetRaceAgentCard` initialization with all required fields

---

### Issue 3: Debug Logging Environment Variable

- **Type**: Documentation Mismatch
- **Severity**: Low
- **Details**:
  - Documentation mentions `STREETRACE_LOG_LEVEL=DEBUG` environment variable
  - Actual implementation uses `--verbose` CLI flag to enable debug logging
  - The `STREETRACE_LOG_LEVEL` environment variable is not implemented
- **Evidence**: `log.py` shows:
  ```python
  if args.verbose:
      root_logger.setLevel(DEBUG)
  ```
  No environment variable handling is present.
- **Recommendation**: Either implement `STREETRACE_LOG_LEVEL` environment variable or update documentation to use `--verbose` flag

---

## Summary

| Metric | Count |
|--------|-------|
| Total Scenarios | 12 |
| Passed | 12 |
| Failed | 0 |
| Issues Found | 3 |
| Documentation Gaps | 3 |

### Pass/Fail by Category

| Category | Status |
|----------|--------|
| DSL Compile-on-Load | PASS |
| DSL Syntax Error Rejection | PASS |
| YAML Definition Loading | PASS |
| Python Definition Loading | PASS |
| WorkloadMetadata Immutability | PASS |
| WorkloadDefinition Required Fields | PASS |
| DefinitionLoader Protocol Compliance | PASS |
| WorkloadManager discover_definitions() | PASS |
| WorkloadNotFoundError | PASS |
| End-to-End DSL Workload Execution | PASS |
| Backward Compatibility | PASS |
| Agent Discovery | PASS |

---

## Recommendations

### Priority 1 (High - Fix Before Release)

1. **Update Python Agent Documentation** (Issue 2)
   - Update user documentation to show complete `StreetRaceAgentCard` initialization
   - Consider adding default values to `StreetRaceAgentCard` for optional fields

### Priority 2 (Medium - Fix Soon)

2. **Update Debug Logging Documentation** (Issue 3)
   - Document the `--verbose` CLI flag as the way to enable debug logging
   - Or implement `STREETRACE_LOG_LEVEL` environment variable

### Priority 3 (Low - Technical Debt)

3. **Standardize DSL Header Usage** (Issue 1)
   - Decide whether `streetrace v1` header is required
   - Update all examples and documentation to be consistent

---

## Test Artifacts

Test agent files created during testing:
- `/home/data/repos/github.com/streetrace-ai/streetrace/agents/test_workloads/basic_dsl.sr`
- `/home/data/repos/github.com/streetrace-ai/streetrace/agents/test_workloads/e2e_test.sr`
- `/home/data/repos/github.com/streetrace-ai/streetrace/agents/test_workloads/invalid_syntax.sr`
- `/home/data/repos/github.com/streetrace-ai/streetrace/agents/test_workloads/basic_yaml.yaml`
- `/home/data/repos/github.com/streetrace-ai/streetrace/agents/test_workloads/basic_python/agent.py`

---

## Comparison with Previous Test Report

The previous test report (2026-01-21-215517) identified two critical bugs:
1. **Session Not Created for Flow Agent Invocation** - `run agent` in flows
2. **Flow Entry Point Post-Processing Fails** - Empty events issue

These scenarios were not retested in this report as they were outside the scope of "Workload Abstraction" testing. The workload abstraction layer itself is functioning correctly. The previous bugs relate to DSL runtime flow execution, which is a separate concern.
