# E2E Test Report: Workload Protocol

**Date**: 2026-01-21 21:55:17 UTC
**Tester**: manual-e2e-tester agent
**Model Used**: anthropic/claude-sonnet-4-5

## Documentation Reviewed

- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/user/workloads/index.md` - User documentation for Workloads
- `/home/data/repos/github.com/streetrace-ai/streetrace/docs/testing/workloads/testing-guide.md` - Testing guide with scenarios
- `/home/data/repos/github.com/streetrace-ai/streetrace/README.md` - Project overview

## Test Environment

- **Working directory**: `/home/data/repos/github.com/streetrace-ai/streetrace`
- **Branch**: `feature/017-streetrace-dsl-2`
- **Python version**: 3.12 (via poetry)
- **Log file**: `./streetrace.log` (cleared before each test)
- **Test agents created in**: `./agents/examples/workloads/`

## Scenarios Tested

### Scenario 1: Basic DSL Agent Execution

- **Source**: Testing guide scenario 1
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=agents/examples/workloads/basic_agent.sr --model=anthropic/claude-sonnet-4-5 --prompt="Say hello"
  ```
- **Expected**: Agent responds with a greeting
- **Actual**: Agent responded with "Hello!"
- **Status**: PASS
- **Notes**: DSL agent executed correctly via Workload Protocol

---

### Scenario 2: Tool Access in Flow-Invoked Agent

- **Source**: Testing guide scenario 2
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/flow_tools.sr --model=anthropic/claude-sonnet-4-5 --prompt="Run"
  ```
- **Expected**: Agent lists files in the current directory using `fs` tool
- **Actual**: Error: `ValueError: Session not found: nested_session`
- **Status**: FAIL
- **Notes**: Critical bug - the `run agent` statement in flows creates an `InMemorySessionService` but does not create a session in it before calling `runner.run_async()`. The ADK Runner requires the session to exist.

**Error traceback (excerpt)**:
```
File "/home/data/repos/github.com/streetrace-ai/streetrace/src/streetrace/dsl/runtime/workflow.py", line 303, in run_agent
    async for event in runner.run_async(
...
ValueError: Session not found: nested_session
```

---

### Scenario 3: Agentic Pattern - Delegate

- **Source**: Testing guide scenario 3
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/delegate_pattern.sr --model=anthropic/claude-sonnet-4-5 --prompt="What is Python async?"
  ```
- **Expected**: Coordinator delegates to specialist, specialist responds about async
- **Actual**:
  - Coordinator called `transfer_to_agent({'agent_name': 'specialist'})`
  - Specialist responded with async/await explanation
- **Status**: PASS
- **Notes**: Delegate pattern works correctly for direct agent execution

---

### Scenario 4: Agentic Pattern - Use

- **Source**: Testing guide scenario 4
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/use_pattern.sr --model=anthropic/claude-sonnet-4-5 --prompt="What is 2 + 2?"
  ```
- **Expected**: Lead agent invokes helper as a tool
- **Actual**:
  - Lead agent called `helper({'request': 'What is 2 + 2?'})`
  - Helper returned `4`
  - Lead responded with the answer
- **Status**: PASS
- **Notes**: Use pattern works correctly - helper agent was invoked as a tool

---

### Scenario 5: Entry Point - Main Flow

- **Source**: Testing guide scenario 5
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/entry_main.sr --model=anthropic/claude-sonnet-4-5 --prompt="Run"
  ```
- **Expected**: Flow main executes, outputs "Flow completed"
- **Actual**: Error: `IndexError: list index out of range`
- **Status**: FAIL
- **Notes**: The main flow executed (log shows `[Workflow] log`), but post-processing fails because flows don't produce ADK events in the same way agents do. The session manager tries to access an empty events list.

**Error traceback (excerpt)**:
```
File "/home/data/repos/github.com/streetrace-ai/streetrace/src/streetrace/session/session_manager.py", line 365, in _squash_turn_events
    last_event = keep_events[-1]
IndexError: list index out of range
```

---

### Scenario 6: Entry Point - Default Agent

- **Source**: Testing guide scenario 6
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/entry_default.sr --model=anthropic/claude-sonnet-4-5 --prompt="Hello"
  ```
- **Expected**: Default (unnamed) agent responds
- **Actual**: Agent responded with "DEFAULT_AGENT_RESPONDING"
- **Status**: PASS
- **Notes**: Entry point selection correctly chose the unnamed agent over the named one

---

### Scenario 7: Entry Point - First Agent

- **Source**: Testing guide scenario 7
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/entry_first.sr --model=anthropic/claude-sonnet-4-5 --prompt="Hello"
  ```
- **Expected**: First defined agent responds
- **Actual**: Agent responded with "FIRST_AGENT_RESPONDING"
- **Status**: PASS
- **Notes**: Entry point selection correctly chose the first defined agent

---

### Scenario 8: Backward Compatibility - YAML Agent

- **Source**: Testing guide scenario 8
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=GenericCodingAssistant --model=anthropic/claude-sonnet-4-5 --prompt="Say hello in one word"
  ```
- **Expected**: YAML agent responds correctly
- **Actual**: Agent responded with "Hello!"
- **Status**: PASS
- **Notes**:
  - Log confirms: `Loading agent 'GenericCodingAssistant' (yaml) from cwd`
  - MCP cleanup warnings appeared but are unrelated to Workload Protocol

**Log excerpt**:
```
2026-01-21 21:54:10,103 - streetrace.workloads.manager - INFO - Loading agent 'GenericCodingAssistant' (yaml) from cwd
```

---

### Scenario 9: WorkloadManager Discovery

- **Source**: Testing guide scenario 9
- **Commands Executed**:
  ```bash
  poetry run streetrace --list-agents
  ```
- **Expected**: Lists all discovered agents with type and location
- **Actual**: Listed 7 agents including YAML, Python, and built-in agents
- **Status**: PASS
- **Notes**: Output included Name, Type, Description, and Location columns

**Sample output**:
```
Name                     Type   Description             Location
GenericCodingAssistant   yaml   A helpful assistant...  /home/data/repos/...
Streetrace_Coding_Agent  python A peer engineer agent   Built-in
```

---

### Scenario 10: Error Handling - Agent Not Found

- **Source**: Testing guide scenario 10
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=nonexistent_agent --model=anthropic/claude-sonnet-4-5 --prompt="Hello"
  ```
- **Expected**: Helpful error message with searched locations
- **Actual**:
  ```
  'nonexistent_agent': Agent 'nonexistent_agent' not found.
  Details:
    - Agent 'nonexistent_agent' not found in locations: cwd, bundled
  Try --list-agents to see available agents.
  ```
- **Status**: PASS
- **Notes**: Error message is clear and actionable

---

### Bonus Scenario: Direct DSL Agent with Tools

- **Source**: Exploratory testing
- **Commands Executed**:
  ```bash
  poetry run streetrace --agent=/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/direct_tools.sr --model=anthropic/claude-sonnet-4-5 --prompt="List files in the current directory"
  ```
- **Expected**: Agent uses filesystem tools to list files
- **Actual**: Agent called `list_directory({'path': '.'})` and displayed directory contents
- **Status**: PASS
- **Notes**: Tools work correctly when DSL agent is run directly (not via flow)

---

## Issues Found

### Issue 1: Session Not Created for Flow Agent Invocation

- **Type**: Bug
- **Severity**: Critical
- **Steps to Reproduce**:
  1. Create a DSL file with `flow main:` that uses `run agent <name>`
  2. Run `poetry run streetrace --agent=<file.sr>`
- **Expected Behavior**: The agent should execute and return results
- **Actual Behavior**: `ValueError: Session not found: nested_session`
- **Evidence**:
  - File: `/home/data/repos/github.com/streetrace-ai/streetrace/src/streetrace/dsl/runtime/workflow.py`
  - Lines 293-306: Creates `InMemorySessionService()` but never creates a session before calling `runner.run_async(session_id="nested_session")`
- **Recommendation**: Before calling `runner.run_async()`, create the session in the InMemorySessionService:
  ```python
  nested_session_service = InMemorySessionService()
  await nested_session_service.create_session(
      app_name="dsl_workflow",
      user_id="workflow_user",
      session_id="nested_session",
  )
  ```

---

### Issue 2: Flow Entry Point Post-Processing Fails

- **Type**: Bug
- **Severity**: High
- **Steps to Reproduce**:
  1. Create a DSL file with `flow main:` (no agent)
  2. Run `poetry run streetrace --agent=<file.sr>`
- **Expected Behavior**: Flow executes and returns result
- **Actual Behavior**: `IndexError: list index out of range` in session manager
- **Evidence**:
  - File: `/home/data/repos/github.com/streetrace-ai/streetrace/src/streetrace/session/session_manager.py`
  - Line 365: `last_event = keep_events[-1]` fails when flow produces no ADK events
- **Recommendation**: Handle the case where a flow workload produces no events:
  ```python
  if not keep_events:
      return None  # or handle appropriately
  last_event = keep_events[-1]
  ```

---

### Issue 3: MCP Session Cleanup Warnings

- **Type**: UX Problem
- **Severity**: Low
- **Steps to Reproduce**: Run any agent with MCP tools
- **Expected Behavior**: Clean shutdown without warnings
- **Actual Behavior**:
  ```
  Warning: Error during MCP session cleanup for stdio_session: Attempted to exit cancel scope in a different task than it was entered in
  ```
- **Evidence**: Observed during Scenario 8 (YAML agent)
- **Recommendation**: Review async task handling in MCP session cleanup

---

## Summary

| Metric | Count |
|--------|-------|
| Total Scenarios | 11 |
| Passed | 9 |
| Failed | 2 |
| Issues Found | 3 |
| Documentation Gaps | 0 |

### Pass/Fail by Category

| Category | Status |
|----------|--------|
| Basic DSL Agent Execution | PASS |
| Tool Access in Flow-Invoked Agent | FAIL |
| Agentic Pattern - Delegate | PASS |
| Agentic Pattern - Use | PASS |
| Entry Point - Main Flow | FAIL |
| Entry Point - Default Agent | PASS |
| Entry Point - First Agent | PASS |
| YAML Agent Backward Compatibility | PASS |
| WorkloadManager Discovery | PASS |
| Error Handling | PASS |
| Direct DSL Agent with Tools | PASS |

---

## Recommendations

### Priority 1 (Critical - Block Release)

1. **Fix Session Creation in Flow Agent Invocation** (Issue 1)
   - The `run agent` statement in flows is completely broken
   - This is a core feature of the Workload Protocol

### Priority 2 (High - Fix Before Release)

2. **Handle Empty Events in Flow Execution** (Issue 2)
   - Flows that don't invoke agents fail in post-processing
   - Users expect to use `flow main:` as an entry point

### Priority 3 (Low - Technical Debt)

3. **Investigate MCP Session Cleanup** (Issue 3)
   - Warnings are confusing but don't affect functionality

---

## Test Artifacts

Test agent files created during testing:
- `/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/basic_agent.sr`
- `/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/flow_tools.sr`
- `/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/delegate_pattern.sr`
- `/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/use_pattern.sr`
- `/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/entry_main.sr`
- `/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/entry_default.sr`
- `/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/entry_first.sr`
- `/home/data/repos/github.com/streetrace-ai/streetrace/agents/examples/workloads/direct_tools.sr`
