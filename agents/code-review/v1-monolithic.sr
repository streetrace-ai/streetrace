# Version 1: Monolithic Code Reviewer
# Single-pass review with structured output
# Baseline for benchmark comparison
#
# Pros: Simple, fast, single LLM call
# Cons: Limited accuracy, no specialization, context window limits

streetrace v1

model main = anthropic/claude-sonnet-4-5

tool github = mcp "https://api.githubcopilot.com/mcp/" with auth bearer "${GITHUB_TOKEN}"
tool fs = builtin streetrace.fs

# -----------------------------------------------------------------------------
# SCHEMAS
# -----------------------------------------------------------------------------

schema Finding:
    file: string
    line: int
    severity: string
    category: string
    title: string
    description: string
    confidence: int
    suggested_fix: string?

schema ReviewResult:
    summary: string
    findings: list[Finding]
    recommendation: string
    confidence_score: int

# -----------------------------------------------------------------------------
# PROMPTS
# -----------------------------------------------------------------------------

prompt scoring_rubric: """## Confidence Scoring Rubric

Score each finding 0-100:

**90-100**: Definite issue - security vuln with exploit path, guaranteed crash
**80-89**: Likely issue - missing null check on nullable, clear logic error
**70-79**: Possible issue - depends on runtime context
**Below 70**: DO NOT REPORT

Only report findings with confidence >= 80."""

prompt reviewer_instruction expecting ReviewResult: """You are an expert code reviewer.

$scoring_rubric

Review the PR for:
1. **Security vulnerabilities**: Injection, auth flaws, secrets exposure
2. **Logic bugs**: Null references, type errors, race conditions
3. **Best practices**: Error handling, resource management

IMPORTANT:
- Focus ONLY on changed code, not pre-existing issues
- Do NOT report linting/formatting issues (handled by CI)
- Provide actionable descriptions with line numbers
- Include suggested fixes where possible

PR Context:
$context

Changed Files (diff):
$diff

Provide a structured review with findings sorted by severity."""

prompt pr_fetcher_instruction: """Fetch PR metadata from GitHub.

Get:
- PR number, title, description, state
- Base and head branches
- Author information
- Linked issues (parse "Fixes #X", "Closes #X" from description)
- Review status

Return structured PR metadata."""

prompt context_instruction: """Build comprehensive review context FOR THIS SPECIFIC PR.

You will receive the PR info. Use it to understand:
- What areas of the codebase are being changed
- What the PR is trying to accomplish
- What review categories are most relevant

Then gather context:
1. Repository context (PR-aware):
   - README.md for project understanding
   - CONTRIBUTING.md for coding guidelines
   - CLAUDE.md or style guides if present
   - Docs specifically relevant to changed areas

2. Historical context (for changed files):
   - Run git blame on key changed lines
   - Get commit messages explaining why code exists
   - Find linked bugs/issues from commit messages
   - Note any recent PRs that touched same files

Return a context summary focused on what the reviewer needs to know
for security, bug detection, and code quality analysis."""

prompt diff_instruction: """Fetch the complete PR diff.

Use GitHub tools to get the diff for all changed files.
Return the raw diff output with context lines."""

# -----------------------------------------------------------------------------
# AGENTS
# -----------------------------------------------------------------------------

agent pr_fetcher:
    tools github
    instruction pr_fetcher_instruction
    description "Fetches PR metadata"

agent context_gatherer:
    tools github, fs
    instruction context_instruction
    description "Gathers PR-aware context with history"

agent diff_fetcher:
    tools github
    instruction diff_instruction
    description "Fetches PR diff from GitHub"

# -----------------------------------------------------------------------------
# MAIN FLOW
# -----------------------------------------------------------------------------

flow main:
    log "V1 Monolithic: Starting review..."

    # 1. Fetch PR info and diff first (needed for context building)
    parallel do
        $pr_info = run agent pr_fetcher $input
        $diff = run agent diff_fetcher $input
    end

    # 2. Build PR-aware context (needs PR info to prioritize relevant context)
    log "Building PR-aware context..."
    $context = run agent context_gatherer $pr_info

    # 3. Combine all context
    $full_context = {
        pr: $pr_info,
        repo_and_history: $context
    }

    # 4. Single-pass review with full context
    log "Running comprehensive review..."
    $review = call llm reviewer_instruction $full_context $diff

    # 5. Post-filter low-confidence findings
    $filtered = filter($review.findings, $f -> $f.confidence >= 80)
    $review.findings = $filtered

    log "Review complete!"
    return $review

# -----------------------------------------------------------------------------
# DEFAULT AGENT
# -----------------------------------------------------------------------------

prompt default_instruction: """You are the V1 Monolithic Code Reviewer.

A simple, fast single-pass reviewer with:
- PR-aware repository context
- Historical context (blame, linked issues)
- Confidence-based filtering

To review a PR, you will:
1. Fetch PR metadata and diff
2. Build context with history for changed files
3. Run comprehensive single-pass review
4. Filter to high-confidence findings only

Provide the PR number, URL, or describe what to review."""

agent:
    tools github, fs
    instruction default_instruction
    description "V1 Monolithic code review agent"
